<!DOCTYPE html>
<html lang="" xml:lang="">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>3 The method | Creating the LCDmix R package</title>
<meta name="description" content="3 The method | Creating the LCDmix R package">
<meta name="generator" content="bookdown 0.43 and GitBook 2.6.7">
<meta property="og:title" content="3 The method | Creating the LCDmix R package">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="3 The method | Creating the LCDmix R package">
<meta name="author" content="Sang-wook Lee">
<meta name="date" content="2025-06-27">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="prev" href="the-model.html">
<link rel="next" href="conclude.html">
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script><link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet">
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet">
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet">
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script><style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
</head>
<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation"><ul class="summary">
<li class="chapter" data-level="1" data-path="index.html">
<a href="index.html"><i class="fa fa-check"></i><b>1</b> Preliminaries</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#description-file"><i class="fa fa-check"></i><b>1.1</b> DESCRIPTION file</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#package-level-documentation"><i class="fa fa-check"></i><b>1.2</b> Package-level documentation</a></li>
</ul>
</li>
<li class="chapter" data-level="2" data-path="the-model.html"><a href="the-model.html"><i class="fa fa-check"></i><b>2</b> The model</a></li>
<li class="chapter" data-level="3" data-path="the-method.html"><a href="the-method.html"><i class="fa fa-check"></i><b>3</b> The method</a></li>
<li class="chapter" data-level="4" data-path="conclude.html"><a href="conclude.html"><i class="fa fa-check"></i><b>4</b> Conclusion</a></li>
</ul></nav>
</div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating the <code>LCDmix</code> R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-"><div id="the-method" class="section level1 hasAnchor" number="3">
<h1>
<span class="header-section-number">3</span> The method<a href="the-method.html#the-method" class="anchor-section" aria-label="Anchor link to header"></a>
</h1>
<p>We are using Expectation-Maximization(EM) algorithm to maximize the surrogate log-likelihood
<span class="math inline">\(Q(\alpha, g, \theta) = \frac{1}{N} \sum_{t=1}^T \sum_{i=1}^{n_t} \sum_{k=1}^K r_{tik} \left[ g_k \left(Y_i^{(t)} -\theta_{k0} -\theta_k^T X^{(t)}  \right)) + \log \pi_{tk}(\alpha)  \right]\)</span>.</p>
<p>Hereâ€™s a high-level look at the algorithm.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="the-method.html#cb41-1" tabindex="-1"></a><span class="co">#' Mixture of log-concave regression</span></span>
<span id="cb41-2"><a href="the-method.html#cb41-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb41-3"><a href="the-method.html#cb41-3" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb41-4"><a href="the-method.html#cb41-4" tabindex="-1"></a><span class="co"># <span id="mixLcdReg">mixLcdReg</span> &lt;- function(X, </span></span>
<span id="cb41-5"><a href="the-method.html#cb41-5" tabindex="-1"></a><span class="co">#                      Y, </span></span>
<span id="cb41-6"><a href="the-method.html#cb41-6" tabindex="-1"></a><span class="co">#                      K, </span></span>
<span id="cb41-7"><a href="the-method.html#cb41-7" tabindex="-1"></a><span class="co">#                      B = 40, </span></span>
<span id="cb41-8"><a href="the-method.html#cb41-8" tabindex="-1"></a><span class="co">#                      min_count_ratio = 0, </span></span>
<span id="cb41-9"><a href="the-method.html#cb41-9" tabindex="-1"></a><span class="co">#                      r_bar, </span></span>
<span id="cb41-10"><a href="the-method.html#cb41-10" tabindex="-1"></a><span class="co">#                      lambda_alpha, </span></span>
<span id="cb41-11"><a href="the-method.html#cb41-11" tabindex="-1"></a><span class="co">#                      lambda_theta, </span></span>
<span id="cb41-12"><a href="the-method.html#cb41-12" tabindex="-1"></a><span class="co">#                      max_iter = 100, </span></span>
<span id="cb41-13"><a href="the-method.html#cb41-13" tabindex="-1"></a><span class="co">#                      iter_eta = 1e-6) {</span></span>
<span id="cb41-14"><a href="the-method.html#cb41-14" tabindex="-1"></a></span>
<span id="cb41-15"><a href="the-method.html#cb41-15" tabindex="-1"></a></span>
<span id="cb41-16"><a href="the-method.html#cb41-16" tabindex="-1"></a>  <span class="co"># preprocessing</span></span>
<span id="cb41-17"><a href="the-method.html#cb41-17" tabindex="-1"></a>  </span>
<span id="cb41-18"><a href="the-method.html#cb41-18" tabindex="-1"></a>  <span class="co"># initialization with flexmix</span></span>
<span id="cb41-19"><a href="the-method.html#cb41-19" tabindex="-1"></a>  </span>
<span id="cb41-20"><a href="the-method.html#cb41-20" tabindex="-1"></a>  <span class="co"># iteration</span></span>
<span id="cb41-21"><a href="the-method.html#cb41-21" tabindex="-1"></a>  <span class="co">#  for (i in seq(max_iter)) {</span></span>
<span id="cb41-22"><a href="the-method.html#cb41-22" tabindex="-1"></a>      <span class="do">## E-step</span></span>
<span id="cb41-23"><a href="the-method.html#cb41-23" tabindex="-1"></a>      </span>
<span id="cb41-24"><a href="the-method.html#cb41-24" tabindex="-1"></a>      <span class="do">## M-step</span></span>
<span id="cb41-25"><a href="the-method.html#cb41-25" tabindex="-1"></a>        <span class="do">### M-step alpha</span></span>
<span id="cb41-26"><a href="the-method.html#cb41-26" tabindex="-1"></a>        <span class="do">### M-step theta</span></span>
<span id="cb41-27"><a href="the-method.html#cb41-27" tabindex="-1"></a>        <span class="do">### M-step shift</span></span>
<span id="cb41-28"><a href="the-method.html#cb41-28" tabindex="-1"></a>        <span class="do">### M-step g</span></span>
<span id="cb41-29"><a href="the-method.html#cb41-29" tabindex="-1"></a>      </span>
<span id="cb41-30"><a href="the-method.html#cb41-30" tabindex="-1"></a>      <span class="do">## termination criteria</span></span>
<span id="cb41-31"><a href="the-method.html#cb41-31" tabindex="-1"></a>      </span>
<span id="cb41-32"><a href="the-method.html#cb41-32" tabindex="-1"></a>  <span class="co">#  }</span></span>
<span id="cb41-33"><a href="the-method.html#cb41-33" tabindex="-1"></a>  <span class="co"># return</span></span>
<span id="cb41-34"><a href="the-method.html#cb41-34" tabindex="-1"></a></span>
<span id="cb41-35"><a href="the-method.html#cb41-35" tabindex="-1"></a><span class="co">#}</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="the-method.html#cb42-1" tabindex="-1"></a><span class="co">#' main</span></span>
<span id="cb42-2"><a href="the-method.html#cb42-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb42-3"><a href="the-method.html#cb42-3" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb42-4"><a href="the-method.html#cb42-4" tabindex="-1"></a>main <span class="ot">=</span> <span class="cf">function</span>(Y, X, biomass, <span class="at">binned =</span> F, <span class="at">B =</span> <span class="dv">40</span>, K, <span class="at">lambda_alpha =</span> <span class="fl">1e-3</span>, <span class="at">lambda_theta =</span> <span class="fl">1e-3</span>, <span class="at">nrep_flowmix =</span> <span class="dv">1</span>, </span>
<span id="cb42-5"><a href="the-method.html#cb42-5" tabindex="-1"></a>                <span class="at">max_iter =</span> <span class="dv">30</span>, <span class="at">iter_eta =</span> <span class="fl">1e-3</span>, <span class="at">maxdev =</span> <span class="cn">NULL</span>, <span class="at">r_bar =</span> <span class="fl">1e-3</span>){</span>
<span id="cb42-6"><a href="the-method.html#cb42-6" tabindex="-1"></a>  </span>
<span id="cb42-7"><a href="the-method.html#cb42-7" tabindex="-1"></a>  <span class="co"># binning</span></span>
<span id="cb42-8"><a href="the-method.html#cb42-8" tabindex="-1"></a>  <span class="cf">if</span> (binned){</span>
<span id="cb42-9"><a href="the-method.html#cb42-9" tabindex="-1"></a>    Y_bin <span class="ot">=</span> Y</span>
<span id="cb42-10"><a href="the-method.html#cb42-10" tabindex="-1"></a>    bin_mass <span class="ot">=</span> biomass</span>
<span id="cb42-11"><a href="the-method.html#cb42-11" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb42-12"><a href="the-method.html#cb42-12" tabindex="-1"></a>    bin <span class="ot">=</span> <span class="fu">binning</span>(Y, biomass, B)</span>
<span id="cb42-13"><a href="the-method.html#cb42-13" tabindex="-1"></a>    Y_bin <span class="ot">=</span> bin<span class="sc">$</span>Y_bin</span>
<span id="cb42-14"><a href="the-method.html#cb42-14" tabindex="-1"></a>    bin_mass <span class="ot">=</span> bin<span class="sc">$</span>bin_mass</span>
<span id="cb42-15"><a href="the-method.html#cb42-15" tabindex="-1"></a>  }</span>
<span id="cb42-16"><a href="the-method.html#cb42-16" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">'passed binning'</span>)</span>
<span id="cb42-17"><a href="the-method.html#cb42-17" tabindex="-1"></a></span>
<span id="cb42-18"><a href="the-method.html#cb42-18" tabindex="-1"></a>  <span class="co"># initial GMR</span></span>
<span id="cb42-19"><a href="the-method.html#cb42-19" tabindex="-1"></a>  initial <span class="ot">=</span> <span class="fu">initialization</span>(Y_bin, X, bin_mass, K, lambda_alpha, lambda_theta, nrep_flowmix, maxdev, r_bar)</span>
<span id="cb42-20"><a href="the-method.html#cb42-20" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">'passed init'</span>)</span>
<span id="cb42-21"><a href="the-method.html#cb42-21" tabindex="-1"></a>  </span>
<span id="cb42-22"><a href="the-method.html#cb42-22" tabindex="-1"></a>  <span class="co"># iteration</span></span>
<span id="cb42-23"><a href="the-method.html#cb42-23" tabindex="-1"></a>  iter <span class="ot">=</span> <span class="fu">iteration</span>(Y_bin, X, bin_mass, initial, lambda_alpha, lambda_theta, iter_eta, max_iter, maxdev, r_bar)</span>
<span id="cb42-24"><a href="the-method.html#cb42-24" tabindex="-1"></a>  </span>
<span id="cb42-25"><a href="the-method.html#cb42-25" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Y_bin =</span> Y_bin,</span>
<span id="cb42-26"><a href="the-method.html#cb42-26" tabindex="-1"></a>              <span class="at">X =</span> X,</span>
<span id="cb42-27"><a href="the-method.html#cb42-27" tabindex="-1"></a>              <span class="at">bin_mass =</span> bin_mass,</span>
<span id="cb42-28"><a href="the-method.html#cb42-28" tabindex="-1"></a>              <span class="at">initial =</span> initial,</span>
<span id="cb42-29"><a href="the-method.html#cb42-29" tabindex="-1"></a>              <span class="at">iter =</span> iter))</span>
<span id="cb42-30"><a href="the-method.html#cb42-30" tabindex="-1"></a>}</span>
<span id="cb42-31"><a href="the-method.html#cb42-31" tabindex="-1"></a></span>
<span id="cb42-32"><a href="the-method.html#cb42-32" tabindex="-1"></a>binning <span class="ot">=</span> <span class="cf">function</span>(Y, biomass, <span class="at">B =</span> <span class="dv">40</span>){</span>
<span id="cb42-33"><a href="the-method.html#cb42-33" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(Y)</span>
<span id="cb42-34"><a href="the-method.html#cb42-34" tabindex="-1"></a>  <span class="cf">if</span> (B <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb42-35"><a href="the-method.html#cb42-35" tabindex="-1"></a>    Y_bin <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-36"><a href="the-method.html#cb42-36" tabindex="-1"></a>    bin_mass <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-37"><a href="the-method.html#cb42-37" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb42-38"><a href="the-method.html#cb42-38" tabindex="-1"></a>      tmp <span class="ot">=</span> <span class="fu">tapply</span>(biomass[[t]], <span class="fu">factor</span>(Y[[t]]), sum)</span>
<span id="cb42-39"><a href="the-method.html#cb42-39" tabindex="-1"></a>      Y_bin[[t]] <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">as.numeric</span>(<span class="fu">names</span>(tmp)), <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb42-40"><a href="the-method.html#cb42-40" tabindex="-1"></a>      bin_mass[[t]] <span class="ot">=</span> <span class="fu">as.numeric</span>(tmp)</span>
<span id="cb42-41"><a href="the-method.html#cb42-41" tabindex="-1"></a>      }</span>
<span id="cb42-42"><a href="the-method.html#cb42-42" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb42-43"><a href="the-method.html#cb42-43" tabindex="-1"></a>      Y_range <span class="ot">=</span> <span class="fu">range</span>(Y)</span>
<span id="cb42-44"><a href="the-method.html#cb42-44" tabindex="-1"></a>      bin <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from =</span> Y_range[<span class="dv">1</span>], <span class="at">to =</span> Y_range[<span class="dv">2</span>], <span class="at">length =</span> B <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb42-45"><a href="the-method.html#cb42-45" tabindex="-1"></a>      binnedY <span class="ot">=</span> <span class="fu">lapply</span>(Y, findInterval, bin, <span class="at">rightmost.closed =</span> T)</span>
<span id="cb42-46"><a href="the-method.html#cb42-46" tabindex="-1"></a>      binnedY <span class="ot">=</span> <span class="fu">lapply</span>(binnedY, factor, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span>B)</span>
<span id="cb42-47"><a href="the-method.html#cb42-47" tabindex="-1"></a>      mid <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, B)</span>
<span id="cb42-48"><a href="the-method.html#cb42-48" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb42-49"><a href="the-method.html#cb42-49" tabindex="-1"></a>        mid[i] <span class="ot">=</span> (bin[i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">+</span> bin[i])<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb42-50"><a href="the-method.html#cb42-50" tabindex="-1"></a>      }</span>
<span id="cb42-51"><a href="the-method.html#cb42-51" tabindex="-1"></a>      Y_bin <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-52"><a href="the-method.html#cb42-52" tabindex="-1"></a>      bin_mass <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-53"><a href="the-method.html#cb42-53" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb42-54"><a href="the-method.html#cb42-54" tabindex="-1"></a>        bin_mass[[t]] <span class="ot">=</span> <span class="fu">tapply</span>(biomass[[t]], binnedY[[t]], sum)</span>
<span id="cb42-55"><a href="the-method.html#cb42-55" tabindex="-1"></a>        <span class="co"># removing bins with zero counts</span></span>
<span id="cb42-56"><a href="the-method.html#cb42-56" tabindex="-1"></a>        tmp <span class="ot">=</span> <span class="sc">!</span><span class="fu">is.na</span>(bin_mass[[t]])</span>
<span id="cb42-57"><a href="the-method.html#cb42-57" tabindex="-1"></a>        Y_bin[[t]] <span class="ot">=</span> <span class="fu">matrix</span>(mid[tmp], <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb42-58"><a href="the-method.html#cb42-58" tabindex="-1"></a>        bin_mass[[t]] <span class="ot">=</span> <span class="fu">c</span>(bin_mass[[t]][tmp])</span>
<span id="cb42-59"><a href="the-method.html#cb42-59" tabindex="-1"></a>      }</span>
<span id="cb42-60"><a href="the-method.html#cb42-60" tabindex="-1"></a>      <span class="fu">names</span>(Y_bin) <span class="ot">=</span> <span class="fu">names</span>(Y)</span>
<span id="cb42-61"><a href="the-method.html#cb42-61" tabindex="-1"></a>  }</span>
<span id="cb42-62"><a href="the-method.html#cb42-62" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">Y_bin =</span> Y_bin,</span>
<span id="cb42-63"><a href="the-method.html#cb42-63" tabindex="-1"></a>           <span class="at">bin_mass =</span> bin_mass))</span>
<span id="cb42-64"><a href="the-method.html#cb42-64" tabindex="-1"></a>}</span>
<span id="cb42-65"><a href="the-method.html#cb42-65" tabindex="-1"></a><span class="co"># could be improved using levels(factor(unlist(Y)))</span></span>
<span id="cb42-66"><a href="the-method.html#cb42-66" tabindex="-1"></a></span>
<span id="cb42-67"><a href="the-method.html#cb42-67" tabindex="-1"></a></span>
<span id="cb42-68"><a href="the-method.html#cb42-68" tabindex="-1"></a></span>
<span id="cb42-69"><a href="the-method.html#cb42-69" tabindex="-1"></a></span>
<span id="cb42-70"><a href="the-method.html#cb42-70" tabindex="-1"></a></span>
<span id="cb42-71"><a href="the-method.html#cb42-71" tabindex="-1"></a></span>
<span id="cb42-72"><a href="the-method.html#cb42-72" tabindex="-1"></a>initialization <span class="ot">=</span> <span class="cf">function</span>(Y_bin, X, bin_mass, K, lambda_alpha, lambda_theta, nrep_flowmix, maxdev, r_bar){</span>
<span id="cb42-73"><a href="the-method.html#cb42-73" tabindex="-1"></a>  </span>
<span id="cb42-74"><a href="the-method.html#cb42-74" tabindex="-1"></a>  flow <span class="ot">=</span> flowmix<span class="sc">::</span><span class="fu">flowmix</span>(Y_bin, X, bin_mass, <span class="at">numclust =</span> K, <span class="at">prob_lambda =</span> lambda_alpha, <span class="at">mean_lambda =</span> lambda_theta, <span class="at">nrep =</span> nrep_flowmix, <span class="at">maxdev =</span> maxdev)</span>
<span id="cb42-75"><a href="the-method.html#cb42-75" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">'passed flowmix'</span>)</span>
<span id="cb42-76"><a href="the-method.html#cb42-76" tabindex="-1"></a>  </span>
<span id="cb42-77"><a href="the-method.html#cb42-77" tabindex="-1"></a>  <span class="do">## initial alpha</span></span>
<span id="cb42-78"><a href="the-method.html#cb42-78" tabindex="-1"></a>  alpha_init <span class="ot">=</span> flow<span class="sc">$</span>alpha</span>
<span id="cb42-79"><a href="the-method.html#cb42-79" tabindex="-1"></a>  </span>
<span id="cb42-80"><a href="the-method.html#cb42-80" tabindex="-1"></a>  <span class="do">## initial theta</span></span>
<span id="cb42-81"><a href="the-method.html#cb42-81" tabindex="-1"></a>  theta0_init <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-82"><a href="the-method.html#cb42-82" tabindex="-1"></a>  theta_init <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-83"><a href="the-method.html#cb42-83" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb42-84"><a href="the-method.html#cb42-84" tabindex="-1"></a>    theta0_init[[k]] <span class="ot">=</span> flow<span class="sc">$</span>beta[[k]][<span class="dv">1</span>]</span>
<span id="cb42-85"><a href="the-method.html#cb42-85" tabindex="-1"></a>    theta_init[[k]] <span class="ot">=</span> flow<span class="sc">$</span>beta[[k]][<span class="dv">2</span><span class="sc">:</span>(<span class="fu">ncol</span>(X)<span class="sc">+</span><span class="dv">1</span>)]</span>
<span id="cb42-86"><a href="the-method.html#cb42-86" tabindex="-1"></a>  }</span>
<span id="cb42-87"><a href="the-method.html#cb42-87" tabindex="-1"></a>  resi_init <span class="ot">=</span> <span class="fu">calc_resi</span>(Y_bin, X, theta0_init, theta_init)</span>
<span id="cb42-88"><a href="the-method.html#cb42-88" tabindex="-1"></a></span>
<span id="cb42-89"><a href="the-method.html#cb42-89" tabindex="-1"></a>  <span class="do">## initial resp</span></span>
<span id="cb42-90"><a href="the-method.html#cb42-90" tabindex="-1"></a>  likeli <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-91"><a href="the-method.html#cb42-91" tabindex="-1"></a>  resp_init <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-92"><a href="the-method.html#cb42-92" tabindex="-1"></a>  weight_init <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-93"><a href="the-method.html#cb42-93" tabindex="-1"></a>  idx_init <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-94"><a href="the-method.html#cb42-94" tabindex="-1"></a>  P <span class="ot">=</span> <span class="fu">pi_k</span>(X, alpha_init)</span>
<span id="cb42-95"><a href="the-method.html#cb42-95" tabindex="-1"></a>  </span>
<span id="cb42-96"><a href="the-method.html#cb42-96" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Y_bin)){</span>
<span id="cb42-97"><a href="the-method.html#cb42-97" tabindex="-1"></a>    likeli[[t]] <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(Y_bin[[t]]), <span class="at">ncol =</span> K)</span>
<span id="cb42-98"><a href="the-method.html#cb42-98" tabindex="-1"></a>    idx_init[[t]] <span class="ot">=</span> <span class="fu">matrix</span>(F, <span class="at">nrow =</span> <span class="fu">nrow</span>(Y_bin[[t]]), <span class="at">ncol =</span> K)</span>
<span id="cb42-99"><a href="the-method.html#cb42-99" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb42-100"><a href="the-method.html#cb42-100" tabindex="-1"></a>      likeli[[t]][,k] <span class="ot">=</span> <span class="fu">dnorm</span>(resi_init[[t]][,k], flow<span class="sc">$</span>mn[t,<span class="dv">1</span>,k], <span class="fu">sqrt</span>(flow<span class="sc">$</span>sigma[k])) <span class="sc">*</span> P[t,k]</span>
<span id="cb42-101"><a href="the-method.html#cb42-101" tabindex="-1"></a>    }</span>
<span id="cb42-102"><a href="the-method.html#cb42-102" tabindex="-1"></a>    resp_init[[t]] <span class="ot">=</span> likeli[[t]]<span class="sc">/</span><span class="fu">rowSums</span>(likeli[[t]])</span>
<span id="cb42-103"><a href="the-method.html#cb42-103" tabindex="-1"></a>    idx_init[[t]] <span class="ot">=</span> resp_init[[t]] <span class="sc">&gt;</span> r_bar     </span>
<span id="cb42-104"><a href="the-method.html#cb42-104" tabindex="-1"></a>    weight_init[[t]] <span class="ot">=</span> resp_init[[t]] <span class="sc">*</span> bin_mass[[t]]</span>
<span id="cb42-105"><a href="the-method.html#cb42-105" tabindex="-1"></a>  }</span>
<span id="cb42-106"><a href="the-method.html#cb42-106" tabindex="-1"></a>  </span>
<span id="cb42-107"><a href="the-method.html#cb42-107" tabindex="-1"></a>  <span class="do">## initial theta shift</span></span>
<span id="cb42-108"><a href="the-method.html#cb42-108" tabindex="-1"></a>  theta0_init <span class="ot">=</span> <span class="fu">Mstep_shift</span>(Y_bin, X, weight_init, idx_init, theta_init)</span>
<span id="cb42-109"><a href="the-method.html#cb42-109" tabindex="-1"></a>  resi_init <span class="ot">=</span> <span class="fu">calc_resi</span>(Y_bin, X, theta0_init, theta_init)</span>
<span id="cb42-110"><a href="the-method.html#cb42-110" tabindex="-1"></a>  </span>
<span id="cb42-111"><a href="the-method.html#cb42-111" tabindex="-1"></a>  <span class="do">## initial g</span></span>
<span id="cb42-112"><a href="the-method.html#cb42-112" tabindex="-1"></a>  g_init <span class="ot">=</span> <span class="fu">Mstep_g_logcondens</span>(resi_init, weight_init, idx_init)</span>
<span id="cb42-113"><a href="the-method.html#cb42-113" tabindex="-1"></a></span>
<span id="cb42-114"><a href="the-method.html#cb42-114" tabindex="-1"></a>  <span class="do">## initial Q</span></span>
<span id="cb42-115"><a href="the-method.html#cb42-115" tabindex="-1"></a>  Q <span class="ot">=</span> <span class="fu">calc_surr_logcondens</span>(X, g_init, resi_init, theta_init, alpha_init, idx_init, weight_init, lambda_alpha, lambda_theta)</span>
<span id="cb42-116"><a href="the-method.html#cb42-116" tabindex="-1"></a>  Q_every <span class="ot">=</span> Q</span>
<span id="cb42-117"><a href="the-method.html#cb42-117" tabindex="-1"></a>  </span>
<span id="cb42-118"><a href="the-method.html#cb42-118" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">flow =</span> flow,</span>
<span id="cb42-119"><a href="the-method.html#cb42-119" tabindex="-1"></a>       <span class="at">idx_init =</span> idx_init,</span>
<span id="cb42-120"><a href="the-method.html#cb42-120" tabindex="-1"></a>       <span class="at">resp_init =</span> resp_init,</span>
<span id="cb42-121"><a href="the-method.html#cb42-121" tabindex="-1"></a>       <span class="at">weight_init =</span> weight_init,</span>
<span id="cb42-122"><a href="the-method.html#cb42-122" tabindex="-1"></a>       <span class="at">theta0_init =</span> theta0_init,</span>
<span id="cb42-123"><a href="the-method.html#cb42-123" tabindex="-1"></a>       <span class="at">theta_init =</span> theta_init,</span>
<span id="cb42-124"><a href="the-method.html#cb42-124" tabindex="-1"></a>       <span class="at">alpha_init =</span> alpha_init,</span>
<span id="cb42-125"><a href="the-method.html#cb42-125" tabindex="-1"></a>       <span class="at">resi_init =</span> resi_init,</span>
<span id="cb42-126"><a href="the-method.html#cb42-126" tabindex="-1"></a>       <span class="at">g_init =</span> g_init,</span>
<span id="cb42-127"><a href="the-method.html#cb42-127" tabindex="-1"></a>       <span class="at">Q =</span> Q,</span>
<span id="cb42-128"><a href="the-method.html#cb42-128" tabindex="-1"></a>       <span class="at">Q_every =</span> Q_every))</span>
<span id="cb42-129"><a href="the-method.html#cb42-129" tabindex="-1"></a>}</span>
<span id="cb42-130"><a href="the-method.html#cb42-130" tabindex="-1"></a></span>
<span id="cb42-131"><a href="the-method.html#cb42-131" tabindex="-1"></a></span>
<span id="cb42-132"><a href="the-method.html#cb42-132" tabindex="-1"></a><span class="co">#' calculating \pi_{tk}(\alpha) = P(Z_i^{(t)} = k| X^(t))</span></span>
<span id="cb42-133"><a href="the-method.html#cb42-133" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb42-134"><a href="the-method.html#cb42-134" tabindex="-1"></a>pi_k <span class="ot">=</span> <span class="cf">function</span>(X, </span>
<span id="cb42-135"><a href="the-method.html#cb42-135" tabindex="-1"></a>                alpha){</span>
<span id="cb42-136"><a href="the-method.html#cb42-136" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">2</span>]</span>
<span id="cb42-137"><a href="the-method.html#cb42-137" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">1</span>]</span>
<span id="cb42-138"><a href="the-method.html#cb42-138" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">dim</span>(alpha)[<span class="dv">1</span>]</span>
<span id="cb42-139"><a href="the-method.html#cb42-139" tabindex="-1"></a>  tmp <span class="ot">=</span> <span class="fu">exp</span>(<span class="fu">t</span>(<span class="fu">matrix</span>(alpha[,<span class="dv">1</span>], <span class="at">ncol =</span> TT, <span class="at">nrow =</span> K)) <span class="sc">+</span> X <span class="sc">%*%</span> <span class="fu">t</span>(alpha[,<span class="dv">2</span><span class="sc">:</span>(p<span class="sc">+</span><span class="dv">1</span>)]))</span>
<span id="cb42-140"><a href="the-method.html#cb42-140" tabindex="-1"></a>  pi_k <span class="ot">=</span> tmp <span class="sc">/</span> <span class="fu">rowSums</span>(tmp) <span class="co"># TT by K matrix</span></span>
<span id="cb42-141"><a href="the-method.html#cb42-141" tabindex="-1"></a>  <span class="fu">return</span>(pi_k) </span>
<span id="cb42-142"><a href="the-method.html#cb42-142" tabindex="-1"></a>}</span>
<span id="cb42-143"><a href="the-method.html#cb42-143" tabindex="-1"></a></span>
<span id="cb42-144"><a href="the-method.html#cb42-144" tabindex="-1"></a></span>
<span id="cb42-145"><a href="the-method.html#cb42-145" tabindex="-1"></a></span>
<span id="cb42-146"><a href="the-method.html#cb42-146" tabindex="-1"></a></span>
<span id="cb42-147"><a href="the-method.html#cb42-147" tabindex="-1"></a>Mstep_shift <span class="ot">=</span> <span class="cf">function</span>(Y_bin,</span>
<span id="cb42-148"><a href="the-method.html#cb42-148" tabindex="-1"></a>                       X,</span>
<span id="cb42-149"><a href="the-method.html#cb42-149" tabindex="-1"></a>                       weight,</span>
<span id="cb42-150"><a href="the-method.html#cb42-150" tabindex="-1"></a>                       idx,</span>
<span id="cb42-151"><a href="the-method.html#cb42-151" tabindex="-1"></a>                       theta){</span>
<span id="cb42-152"><a href="the-method.html#cb42-152" tabindex="-1"></a>  theta0 <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-153"><a href="the-method.html#cb42-153" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(theta)){</span>
<span id="cb42-154"><a href="the-method.html#cb42-154" tabindex="-1"></a>    <span class="co"># except for the intercept term</span></span>
<span id="cb42-155"><a href="the-method.html#cb42-155" tabindex="-1"></a>    up <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb42-156"><a href="the-method.html#cb42-156" tabindex="-1"></a>    down <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb42-157"><a href="the-method.html#cb42-157" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Y_bin)){</span>
<span id="cb42-158"><a href="the-method.html#cb42-158" tabindex="-1"></a>      idx_tk <span class="ot">=</span> idx[[t]][,k]</span>
<span id="cb42-159"><a href="the-method.html#cb42-159" tabindex="-1"></a>      weight_tk <span class="ot">=</span> weight[[t]][idx_tk,k]</span>
<span id="cb42-160"><a href="the-method.html#cb42-160" tabindex="-1"></a>      up <span class="ot">=</span> up <span class="sc">+</span> weight_tk <span class="sc">%*%</span> Y_bin[[t]][idx_tk] <span class="sc">-</span> <span class="fu">sum</span>(weight_tk) <span class="sc">*</span> <span class="fu">sum</span>(X[t,] <span class="sc">*</span> theta[[k]])</span>
<span id="cb42-161"><a href="the-method.html#cb42-161" tabindex="-1"></a>      down <span class="ot">=</span> down <span class="sc">+</span> <span class="fu">sum</span>(weight_tk)</span>
<span id="cb42-162"><a href="the-method.html#cb42-162" tabindex="-1"></a>    }</span>
<span id="cb42-163"><a href="the-method.html#cb42-163" tabindex="-1"></a>    theta0[[k]] <span class="ot">=</span> up<span class="sc">/</span>down</span>
<span id="cb42-164"><a href="the-method.html#cb42-164" tabindex="-1"></a>  }</span>
<span id="cb42-165"><a href="the-method.html#cb42-165" tabindex="-1"></a>  <span class="fu">return</span>(theta0)</span>
<span id="cb42-166"><a href="the-method.html#cb42-166" tabindex="-1"></a>}</span>
<span id="cb42-167"><a href="the-method.html#cb42-167" tabindex="-1"></a></span>
<span id="cb42-168"><a href="the-method.html#cb42-168" tabindex="-1"></a></span>
<span id="cb42-169"><a href="the-method.html#cb42-169" tabindex="-1"></a>calc_resi <span class="ot">=</span> <span class="cf">function</span>(Y_bin,</span>
<span id="cb42-170"><a href="the-method.html#cb42-170" tabindex="-1"></a>                     X,</span>
<span id="cb42-171"><a href="the-method.html#cb42-171" tabindex="-1"></a>                     theta0,</span>
<span id="cb42-172"><a href="the-method.html#cb42-172" tabindex="-1"></a>                     theta){</span>
<span id="cb42-173"><a href="the-method.html#cb42-173" tabindex="-1"></a>  resi <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-174"><a href="the-method.html#cb42-174" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">length</span>(theta0)</span>
<span id="cb42-175"><a href="the-method.html#cb42-175" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Y_bin)){</span>
<span id="cb42-176"><a href="the-method.html#cb42-176" tabindex="-1"></a>    resi[[t]] <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">length</span>(Y_bin[[t]]), <span class="at">ncol =</span> K)</span>
<span id="cb42-177"><a href="the-method.html#cb42-177" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb42-178"><a href="the-method.html#cb42-178" tabindex="-1"></a>      resi[[t]][,k] <span class="ot">=</span> Y_bin[[t]] <span class="sc">-</span> <span class="fu">c</span>(theta0[[k]] <span class="sc">+</span> <span class="fu">sum</span>(X[t,] <span class="sc">*</span> theta[[k]]))</span>
<span id="cb42-179"><a href="the-method.html#cb42-179" tabindex="-1"></a>    }</span>
<span id="cb42-180"><a href="the-method.html#cb42-180" tabindex="-1"></a>  }</span>
<span id="cb42-181"><a href="the-method.html#cb42-181" tabindex="-1"></a>  <span class="fu">return</span>(resi) <span class="co"># length TT list, with `resi[[t]]` being N_t by K matrix</span></span>
<span id="cb42-182"><a href="the-method.html#cb42-182" tabindex="-1"></a>}</span>
<span id="cb42-183"><a href="the-method.html#cb42-183" tabindex="-1"></a></span>
<span id="cb42-184"><a href="the-method.html#cb42-184" tabindex="-1"></a></span>
<span id="cb42-185"><a href="the-method.html#cb42-185" tabindex="-1"></a></span>
<span id="cb42-186"><a href="the-method.html#cb42-186" tabindex="-1"></a>Mstep_g_logcondens <span class="ot">=</span> <span class="cf">function</span>(resi, </span>
<span id="cb42-187"><a href="the-method.html#cb42-187" tabindex="-1"></a>                              weight,</span>
<span id="cb42-188"><a href="the-method.html#cb42-188" tabindex="-1"></a>                              idx){</span>
<span id="cb42-189"><a href="the-method.html#cb42-189" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(weight)</span>
<span id="cb42-190"><a href="the-method.html#cb42-190" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">dim</span>(idx[[<span class="dv">1</span>]])[<span class="dv">2</span>]</span>
<span id="cb42-191"><a href="the-method.html#cb42-191" tabindex="-1"></a>  </span>
<span id="cb42-192"><a href="the-method.html#cb42-192" tabindex="-1"></a>  g <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-193"><a href="the-method.html#cb42-193" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb42-194"><a href="the-method.html#cb42-194" tabindex="-1"></a>    resi_k <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-195"><a href="the-method.html#cb42-195" tabindex="-1"></a>    w_k <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-196"><a href="the-method.html#cb42-196" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb42-197"><a href="the-method.html#cb42-197" tabindex="-1"></a>      idx_tk <span class="ot">=</span> idx[[t]][,k]</span>
<span id="cb42-198"><a href="the-method.html#cb42-198" tabindex="-1"></a>      weight_tk <span class="ot">=</span> weight[[t]][idx_tk,k]</span>
<span id="cb42-199"><a href="the-method.html#cb42-199" tabindex="-1"></a>      resi_k <span class="ot">=</span> <span class="fu">c</span>(resi_k, resi[[t]][idx_tk,k])</span>
<span id="cb42-200"><a href="the-method.html#cb42-200" tabindex="-1"></a>      w_k <span class="ot">=</span> <span class="fu">c</span>(w_k, weight_tk)</span>
<span id="cb42-201"><a href="the-method.html#cb42-201" tabindex="-1"></a>    }</span>
<span id="cb42-202"><a href="the-method.html#cb42-202" tabindex="-1"></a>    uniq_resi_k <span class="ot">=</span> <span class="fu">unique</span>(resi_k)</span>
<span id="cb42-203"><a href="the-method.html#cb42-203" tabindex="-1"></a>    M <span class="ot">=</span> <span class="fu">length</span>(uniq_resi_k)</span>
<span id="cb42-204"><a href="the-method.html#cb42-204" tabindex="-1"></a>    <span class="cf">if</span> (M <span class="sc">&lt;</span> <span class="dv">5</span>) {</span>
<span id="cb42-205"><a href="the-method.html#cb42-205" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"There are only"</span>, M, <span class="st">"points in Cluster"</span>, k))</span>
<span id="cb42-206"><a href="the-method.html#cb42-206" tabindex="-1"></a>    }</span>
<span id="cb42-207"><a href="the-method.html#cb42-207" tabindex="-1"></a>    uniq_wk <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, M)</span>
<span id="cb42-208"><a href="the-method.html#cb42-208" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M){</span>
<span id="cb42-209"><a href="the-method.html#cb42-209" tabindex="-1"></a>      uniq_wk[j] <span class="ot">=</span> <span class="fu">sum</span>(w_k[uniq_resi_k[j] <span class="sc">==</span> resi_k])</span>
<span id="cb42-210"><a href="the-method.html#cb42-210" tabindex="-1"></a>    }</span>
<span id="cb42-211"><a href="the-method.html#cb42-211" tabindex="-1"></a>    <span class="co">#g[[k]] = logcondens::activeSetLogCon(uniq_resi_k, w = uniq_wk / sum(uniq_wk), print = FALSE)</span></span>
<span id="cb42-212"><a href="the-method.html#cb42-212" tabindex="-1"></a>    g[[k]] <span class="ot">=</span> <span class="fu">modified_logcondens</span>(uniq_resi_k, <span class="at">w =</span> uniq_wk <span class="sc">/</span> <span class="fu">sum</span>(uniq_wk), <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb42-213"><a href="the-method.html#cb42-213" tabindex="-1"></a>  }</span>
<span id="cb42-214"><a href="the-method.html#cb42-214" tabindex="-1"></a>  <span class="fu">return</span>(g)</span>
<span id="cb42-215"><a href="the-method.html#cb42-215" tabindex="-1"></a>}</span>
<span id="cb42-216"><a href="the-method.html#cb42-216" tabindex="-1"></a></span>
<span id="cb42-217"><a href="the-method.html#cb42-217" tabindex="-1"></a>modified_logcondens <span class="ot">=</span> <span class="cf">function</span>(x, <span class="at">xgrid =</span> <span class="cn">NULL</span>, <span class="at">print =</span> <span class="cn">FALSE</span>, <span class="at">w =</span> <span class="cn">NA</span>){</span>
<span id="cb42-218"><a href="the-method.html#cb42-218" tabindex="-1"></a>    prec <span class="ot">&lt;-</span> <span class="fl">1e-10</span></span>
<span id="cb42-219"><a href="the-method.html#cb42-219" tabindex="-1"></a>    xn <span class="ot">&lt;-</span> <span class="fu">sort</span>(x)</span>
<span id="cb42-220"><a href="the-method.html#cb42-220" tabindex="-1"></a>    <span class="cf">if</span> ((<span class="sc">!</span><span class="fu">identical</span>(xgrid, <span class="cn">NULL</span>) <span class="sc">&amp;</span> (<span class="sc">!</span><span class="fu">identical</span>(w, <span class="cn">NA</span>)))) {</span>
<span id="cb42-221"><a href="the-method.html#cb42-221" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"If w != NA then xgrid must be NULL!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-222"><a href="the-method.html#cb42-222" tabindex="-1"></a>    }</span>
<span id="cb42-223"><a href="the-method.html#cb42-223" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">identical</span>(w, <span class="cn">NA</span>)) {</span>
<span id="cb42-224"><a href="the-method.html#cb42-224" tabindex="-1"></a>        tmp <span class="ot">&lt;-</span> logcondens<span class="sc">::</span><span class="fu">preProcess</span>(x, <span class="at">xgrid =</span> xgrid)</span>
<span id="cb42-225"><a href="the-method.html#cb42-225" tabindex="-1"></a>        x <span class="ot">&lt;-</span> tmp<span class="sc">$</span>x</span>
<span id="cb42-226"><a href="the-method.html#cb42-226" tabindex="-1"></a>        w <span class="ot">&lt;-</span> tmp<span class="sc">$</span>w</span>
<span id="cb42-227"><a href="the-method.html#cb42-227" tabindex="-1"></a>        sig <span class="ot">&lt;-</span> tmp<span class="sc">$</span>sig</span>
<span id="cb42-228"><a href="the-method.html#cb42-228" tabindex="-1"></a>    }</span>
<span id="cb42-229"><a href="the-method.html#cb42-229" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">identical</span>(w, <span class="cn">NA</span>)) {</span>
<span id="cb42-230"><a href="the-method.html#cb42-230" tabindex="-1"></a>        tmp <span class="ot">&lt;-</span> <span class="fu">cbind</span>(x, w)</span>
<span id="cb42-231"><a href="the-method.html#cb42-231" tabindex="-1"></a>        tmp <span class="ot">&lt;-</span> tmp[<span class="fu">order</span>(x), ]</span>
<span id="cb42-232"><a href="the-method.html#cb42-232" tabindex="-1"></a>        x <span class="ot">&lt;-</span> tmp[, <span class="dv">1</span>]</span>
<span id="cb42-233"><a href="the-method.html#cb42-233" tabindex="-1"></a>        w <span class="ot">&lt;-</span> tmp[, <span class="dv">2</span>]</span>
<span id="cb42-234"><a href="the-method.html#cb42-234" tabindex="-1"></a>        est.m <span class="ot">&lt;-</span> <span class="fu">sum</span>(w <span class="sc">*</span> x)</span>
<span id="cb42-235"><a href="the-method.html#cb42-235" tabindex="-1"></a>        est.sd <span class="ot">&lt;-</span> <span class="fu">sum</span>(w <span class="sc">*</span> (x <span class="sc">-</span> est.m)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb42-236"><a href="the-method.html#cb42-236" tabindex="-1"></a>        est.sd <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(est.sd <span class="sc">*</span> <span class="fu">length</span>(x)<span class="sc">/</span>(<span class="fu">length</span>(x) <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb42-237"><a href="the-method.html#cb42-237" tabindex="-1"></a>        sig <span class="ot">&lt;-</span> est.sd</span>
<span id="cb42-238"><a href="the-method.html#cb42-238" tabindex="-1"></a>    }</span>
<span id="cb42-239"><a href="the-method.html#cb42-239" tabindex="-1"></a>    n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb42-240"><a href="the-method.html#cb42-240" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> logcondens<span class="sc">::</span><span class="fu">LocalNormalize</span>(x, <span class="dv">1</span><span class="sc">:</span>n <span class="sc">*</span> <span class="dv">0</span>)</span>
<span id="cb42-241"><a href="the-method.html#cb42-241" tabindex="-1"></a>    IsKnot <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>n <span class="sc">*</span> <span class="dv">0</span></span>
<span id="cb42-242"><a href="the-method.html#cb42-242" tabindex="-1"></a>    IsKnot[<span class="fu">c</span>(<span class="dv">1</span>, n)] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb42-243"><a href="the-method.html#cb42-243" tabindex="-1"></a>    res1 <span class="ot">&lt;-</span> logcondens<span class="sc">::</span><span class="fu">LocalMLE</span>(<span class="at">x =</span> x, <span class="at">w =</span> w, <span class="at">IsKnot =</span> IsKnot, <span class="at">phi_o =</span> phi, </span>
<span id="cb42-244"><a href="the-method.html#cb42-244" tabindex="-1"></a>        <span class="at">prec =</span> prec)</span>
<span id="cb42-245"><a href="the-method.html#cb42-245" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> res1<span class="sc">$</span>phi</span>
<span id="cb42-246"><a href="the-method.html#cb42-246" tabindex="-1"></a>    L <span class="ot">&lt;-</span> res1<span class="sc">$</span>L</span>
<span id="cb42-247"><a href="the-method.html#cb42-247" tabindex="-1"></a>    conv <span class="ot">&lt;-</span> res1<span class="sc">$</span>conv</span>
<span id="cb42-248"><a href="the-method.html#cb42-248" tabindex="-1"></a>    H <span class="ot">&lt;-</span> res1<span class="sc">$</span>H</span>
<span id="cb42-249"><a href="the-method.html#cb42-249" tabindex="-1"></a>    iter1 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb42-250"><a href="the-method.html#cb42-250" tabindex="-1"></a>    <span class="cf">while</span> ((iter1 <span class="sc">&lt;</span> <span class="dv">500</span>) <span class="sc">&amp;</span> (<span class="fu">max</span>(H) <span class="sc">&gt;</span> prec <span class="sc">*</span> <span class="fu">mean</span>(<span class="fu">abs</span>(H)))) {</span>
<span id="cb42-251"><a href="the-method.html#cb42-251" tabindex="-1"></a>        IsKnot_old <span class="ot">&lt;-</span> IsKnot</span>
<span id="cb42-252"><a href="the-method.html#cb42-252" tabindex="-1"></a>        iter1 <span class="ot">&lt;-</span> iter1 <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb42-253"><a href="the-method.html#cb42-253" tabindex="-1"></a>        tmp <span class="ot">&lt;-</span> <span class="fu">max</span>(H)</span>
<span id="cb42-254"><a href="the-method.html#cb42-254" tabindex="-1"></a>        k <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span>n) <span class="sc">*</span> (H <span class="sc">==</span> tmp)</span>
<span id="cb42-255"><a href="the-method.html#cb42-255" tabindex="-1"></a>        k <span class="ot">&lt;-</span> <span class="fu">min</span>(k[k <span class="sc">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb42-256"><a href="the-method.html#cb42-256" tabindex="-1"></a>        IsKnot[k] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb42-257"><a href="the-method.html#cb42-257" tabindex="-1"></a>        res2 <span class="ot">&lt;-</span> logcondens<span class="sc">::</span><span class="fu">LocalMLE</span>(x, w, IsKnot, phi, prec)</span>
<span id="cb42-258"><a href="the-method.html#cb42-258" tabindex="-1"></a>        phi_new <span class="ot">&lt;-</span> res2<span class="sc">$</span>phi</span>
<span id="cb42-259"><a href="the-method.html#cb42-259" tabindex="-1"></a>        L <span class="ot">&lt;-</span> res2<span class="sc">$</span>L</span>
<span id="cb42-260"><a href="the-method.html#cb42-260" tabindex="-1"></a>        conv_new <span class="ot">&lt;-</span> res2<span class="sc">$</span>conv</span>
<span id="cb42-261"><a href="the-method.html#cb42-261" tabindex="-1"></a>        H <span class="ot">&lt;-</span> res2<span class="sc">$</span>H</span>
<span id="cb42-262"><a href="the-method.html#cb42-262" tabindex="-1"></a>        <span class="cf">while</span> ((<span class="fu">max</span>(conv_new) <span class="sc">&gt;</span> prec <span class="sc">*</span> <span class="fu">max</span>(<span class="fu">abs</span>(conv_new)))) {</span>
<span id="cb42-263"><a href="the-method.html#cb42-263" tabindex="-1"></a>            JJ <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span>n) <span class="sc">*</span> (conv_new <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb42-264"><a href="the-method.html#cb42-264" tabindex="-1"></a>            JJ <span class="ot">&lt;-</span> JJ[JJ <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb42-265"><a href="the-method.html#cb42-265" tabindex="-1"></a>            <span class="cf">if</span> (<span class="fu">length</span>(JJ) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> conv[JJ] <span class="sc">==</span> conv_new[JJ]){ <span class="co"># inserted</span></span>
<span id="cb42-266"><a href="the-method.html#cb42-266" tabindex="-1"></a>              <span class="fu">print</span>(<span class="st">'break'</span>)</span>
<span id="cb42-267"><a href="the-method.html#cb42-267" tabindex="-1"></a>              <span class="cf">break</span></span>
<span id="cb42-268"><a href="the-method.html#cb42-268" tabindex="-1"></a>              } </span>
<span id="cb42-269"><a href="the-method.html#cb42-269" tabindex="-1"></a>            tmp <span class="ot">&lt;-</span> conv[JJ]<span class="sc">/</span>(conv[JJ] <span class="sc">-</span> conv_new[JJ])</span>
<span id="cb42-270"><a href="the-method.html#cb42-270" tabindex="-1"></a>            lambda <span class="ot">&lt;-</span> <span class="fu">min</span>(tmp)</span>
<span id="cb42-271"><a href="the-method.html#cb42-271" tabindex="-1"></a>            KK <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(JJ)) <span class="sc">*</span> (tmp <span class="sc">==</span> lambda)</span>
<span id="cb42-272"><a href="the-method.html#cb42-272" tabindex="-1"></a>            KK <span class="ot">&lt;-</span> KK[KK <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb42-273"><a href="the-method.html#cb42-273" tabindex="-1"></a>            IsKnot[JJ[KK]] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb42-274"><a href="the-method.html#cb42-274" tabindex="-1"></a>            phi <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> lambda) <span class="sc">*</span> phi <span class="sc">+</span> lambda <span class="sc">*</span> phi_new</span>
<span id="cb42-275"><a href="the-method.html#cb42-275" tabindex="-1"></a>            conv <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">c</span>(logcondens<span class="sc">::</span><span class="fu">LocalConvexity</span>(x, phi), <span class="dv">0</span>))</span>
<span id="cb42-276"><a href="the-method.html#cb42-276" tabindex="-1"></a>            res3 <span class="ot">&lt;-</span> logcondens<span class="sc">::</span><span class="fu">LocalMLE</span>(x, w, IsKnot, phi, prec)</span>
<span id="cb42-277"><a href="the-method.html#cb42-277" tabindex="-1"></a>            phi_new <span class="ot">&lt;-</span> res3<span class="sc">$</span>phi</span>
<span id="cb42-278"><a href="the-method.html#cb42-278" tabindex="-1"></a>            L <span class="ot">&lt;-</span> res3<span class="sc">$</span>L</span>
<span id="cb42-279"><a href="the-method.html#cb42-279" tabindex="-1"></a>            conv_new <span class="ot">&lt;-</span> res3<span class="sc">$</span>conv</span>
<span id="cb42-280"><a href="the-method.html#cb42-280" tabindex="-1"></a>            H <span class="ot">&lt;-</span> res3<span class="sc">$</span>H</span>
<span id="cb42-281"><a href="the-method.html#cb42-281" tabindex="-1"></a>        }</span>
<span id="cb42-282"><a href="the-method.html#cb42-282" tabindex="-1"></a>        phi <span class="ot">&lt;-</span> phi_new</span>
<span id="cb42-283"><a href="the-method.html#cb42-283" tabindex="-1"></a>        conv <span class="ot">&lt;-</span> conv_new</span>
<span id="cb42-284"><a href="the-method.html#cb42-284" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">sum</span>(IsKnot <span class="sc">!=</span> IsKnot_old) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb42-285"><a href="the-method.html#cb42-285" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb42-286"><a href="the-method.html#cb42-286" tabindex="-1"></a>        }</span>
<span id="cb42-287"><a href="the-method.html#cb42-287" tabindex="-1"></a>        <span class="cf">if</span> (print <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb42-288"><a href="the-method.html#cb42-288" tabindex="-1"></a>            <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"iter1 = "</span>, iter1 <span class="sc">-</span> <span class="dv">1</span>, <span class="st">" / L = "</span>, <span class="fu">round</span>(L, </span>
<span id="cb42-289"><a href="the-method.html#cb42-289" tabindex="-1"></a>                <span class="dv">4</span>), <span class="st">" / max(H) = "</span>, <span class="fu">round</span>(<span class="fu">max</span>(H), <span class="dv">4</span>), <span class="st">" / #knots = "</span>, </span>
<span id="cb42-290"><a href="the-method.html#cb42-290" tabindex="-1"></a>                <span class="fu">sum</span>(IsKnot), <span class="at">sep =</span> <span class="st">""</span>))</span>
<span id="cb42-291"><a href="the-method.html#cb42-291" tabindex="-1"></a>        }</span>
<span id="cb42-292"><a href="the-method.html#cb42-292" tabindex="-1"></a>    }</span>
<span id="cb42-293"><a href="the-method.html#cb42-293" tabindex="-1"></a>    Fhat <span class="ot">&lt;-</span> logcondens<span class="sc">::</span><span class="fu">LocalF</span>(x, phi)</span>
<span id="cb42-294"><a href="the-method.html#cb42-294" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">xn =</span> xn, <span class="at">x =</span> x, <span class="at">w =</span> w, <span class="at">phi =</span> <span class="fu">as.vector</span>(phi), </span>
<span id="cb42-295"><a href="the-method.html#cb42-295" tabindex="-1"></a>        <span class="at">IsKnot =</span> IsKnot, <span class="at">L =</span> L, <span class="at">Fhat =</span> <span class="fu">as.vector</span>(Fhat), <span class="at">H =</span> <span class="fu">as.vector</span>(H), </span>
<span id="cb42-296"><a href="the-method.html#cb42-296" tabindex="-1"></a>        <span class="at">n =</span> <span class="fu">length</span>(xn), <span class="at">m =</span> n, <span class="at">knots =</span> x[IsKnot <span class="sc">==</span> <span class="dv">1</span>], <span class="at">mode =</span> x[phi <span class="sc">==</span> </span>
<span id="cb42-297"><a href="the-method.html#cb42-297" tabindex="-1"></a>            <span class="fu">max</span>(phi)], <span class="at">sig =</span> sig)</span>
<span id="cb42-298"><a href="the-method.html#cb42-298" tabindex="-1"></a>    <span class="fu">return</span>(res)</span>
<span id="cb42-299"><a href="the-method.html#cb42-299" tabindex="-1"></a>}</span>
<span id="cb42-300"><a href="the-method.html#cb42-300" tabindex="-1"></a></span>
<span id="cb42-301"><a href="the-method.html#cb42-301" tabindex="-1"></a></span>
<span id="cb42-302"><a href="the-method.html#cb42-302" tabindex="-1"></a></span>
<span id="cb42-303"><a href="the-method.html#cb42-303" tabindex="-1"></a></span>
<span id="cb42-304"><a href="the-method.html#cb42-304" tabindex="-1"></a><span class="co">#' calculating the surrogate loglikelihood Q</span></span>
<span id="cb42-305"><a href="the-method.html#cb42-305" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb42-306"><a href="the-method.html#cb42-306" tabindex="-1"></a>calc_surr_logcondens <span class="ot">=</span> <span class="cf">function</span>(X,</span>
<span id="cb42-307"><a href="the-method.html#cb42-307" tabindex="-1"></a>                                g, </span>
<span id="cb42-308"><a href="the-method.html#cb42-308" tabindex="-1"></a>                                resi, </span>
<span id="cb42-309"><a href="the-method.html#cb42-309" tabindex="-1"></a>                                theta,</span>
<span id="cb42-310"><a href="the-method.html#cb42-310" tabindex="-1"></a>                                alpha, </span>
<span id="cb42-311"><a href="the-method.html#cb42-311" tabindex="-1"></a>                                idx,</span>
<span id="cb42-312"><a href="the-method.html#cb42-312" tabindex="-1"></a>                                weight,</span>
<span id="cb42-313"><a href="the-method.html#cb42-313" tabindex="-1"></a>                                lambda_alpha,</span>
<span id="cb42-314"><a href="the-method.html#cb42-314" tabindex="-1"></a>                                lambda_theta){</span>
<span id="cb42-315"><a href="the-method.html#cb42-315" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">length</span>(g)</span>
<span id="cb42-316"><a href="the-method.html#cb42-316" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(weight))</span>
<span id="cb42-317"><a href="the-method.html#cb42-317" tabindex="-1"></a>  P <span class="ot">=</span> <span class="fu">pi_k</span>(X, alpha) <span class="co"># TT by K matrix</span></span>
<span id="cb42-318"><a href="the-method.html#cb42-318" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">2</span>]</span>
<span id="cb42-319"><a href="the-method.html#cb42-319" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">1</span>]</span>
<span id="cb42-320"><a href="the-method.html#cb42-320" tabindex="-1"></a>  total <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb42-321"><a href="the-method.html#cb42-321" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb42-322"><a href="the-method.html#cb42-322" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb42-323"><a href="the-method.html#cb42-323" tabindex="-1"></a>      idx_tk <span class="ot">=</span> idx[[t]][,k]</span>
<span id="cb42-324"><a href="the-method.html#cb42-324" tabindex="-1"></a>      resi_tk <span class="ot">=</span> resi[[t]][idx_tk,k]</span>
<span id="cb42-325"><a href="the-method.html#cb42-325" tabindex="-1"></a>      weight_tk <span class="ot">=</span> weight[[t]][idx_tk,k]</span>
<span id="cb42-326"><a href="the-method.html#cb42-326" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(weight_tk) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb42-327"><a href="the-method.html#cb42-327" tabindex="-1"></a>        <span class="fu">suppressWarnings</span>({tmp <span class="ot">=</span> weight_tk <span class="sc">*</span> logcondens<span class="sc">::</span><span class="fu">evaluateLogConDens</span>(resi_tk, g[[k]])[,<span class="dv">2</span>]})</span>
<span id="cb42-328"><a href="the-method.html#cb42-328" tabindex="-1"></a>        total <span class="ot">=</span> total <span class="sc">+</span> <span class="fu">sum</span>(tmp[<span class="sc">!</span><span class="fu">is.infinite</span>(tmp)]) <span class="sc">+</span> <span class="fu">sum</span>(weight_tk[<span class="sc">!</span><span class="fu">is.infinite</span>(tmp)]) <span class="sc">*</span> <span class="fu">log</span>(P[t,k])</span>
<span id="cb42-329"><a href="the-method.html#cb42-329" tabindex="-1"></a>      }</span>
<span id="cb42-330"><a href="the-method.html#cb42-330" tabindex="-1"></a>    }</span>
<span id="cb42-331"><a href="the-method.html#cb42-331" tabindex="-1"></a>  }</span>
<span id="cb42-332"><a href="the-method.html#cb42-332" tabindex="-1"></a>  Q <span class="ot">=</span> total<span class="sc">/</span>N <span class="sc">-</span> lambda_alpha <span class="sc">*</span> <span class="fu">sum</span>(<span class="fu">abs</span>(alpha[,<span class="dv">2</span><span class="sc">:</span>(p<span class="sc">+</span><span class="dv">1</span>)])) <span class="sc">-</span> lambda_theta <span class="sc">*</span> <span class="fu">sum</span>(<span class="fu">abs</span>(<span class="fu">unlist</span>(theta)))</span>
<span id="cb42-333"><a href="the-method.html#cb42-333" tabindex="-1"></a>  <span class="fu">return</span>(Q)</span>
<span id="cb42-334"><a href="the-method.html#cb42-334" tabindex="-1"></a>}</span>
<span id="cb42-335"><a href="the-method.html#cb42-335" tabindex="-1"></a></span>
<span id="cb42-336"><a href="the-method.html#cb42-336" tabindex="-1"></a></span>
<span id="cb42-337"><a href="the-method.html#cb42-337" tabindex="-1"></a></span>
<span id="cb42-338"><a href="the-method.html#cb42-338" tabindex="-1"></a></span>
<span id="cb42-339"><a href="the-method.html#cb42-339" tabindex="-1"></a><span class="co">#Y_bin = Y_tr</span></span>
<span id="cb42-340"><a href="the-method.html#cb42-340" tabindex="-1"></a><span class="co">#X = X_tr</span></span>
<span id="cb42-341"><a href="the-method.html#cb42-341" tabindex="-1"></a><span class="co">#bin_mass = bin_mass_tr</span></span>
<span id="cb42-342"><a href="the-method.html#cb42-342" tabindex="-1"></a></span>
<span id="cb42-343"><a href="the-method.html#cb42-343" tabindex="-1"></a></span>
<span id="cb42-344"><a href="the-method.html#cb42-344" tabindex="-1"></a>iteration <span class="ot">=</span> <span class="cf">function</span>(Y_bin, X, bin_mass, initial, lambda_alpha, lambda_theta, <span class="at">iter_eta =</span> <span class="fl">1e-6</span>, <span class="at">max_iter =</span> <span class="dv">30</span>, maxdev, r_bar){</span>
<span id="cb42-345"><a href="the-method.html#cb42-345" tabindex="-1"></a>  </span>
<span id="cb42-346"><a href="the-method.html#cb42-346" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">length</span>(initial<span class="sc">$</span>g_init)</span>
<span id="cb42-347"><a href="the-method.html#cb42-347" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">2</span>]</span>
<span id="cb42-348"><a href="the-method.html#cb42-348" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">1</span>]</span>
<span id="cb42-349"><a href="the-method.html#cb42-349" tabindex="-1"></a>  </span>
<span id="cb42-350"><a href="the-method.html#cb42-350" tabindex="-1"></a>  idx_old <span class="ot">=</span> initial<span class="sc">$</span>idx_init</span>
<span id="cb42-351"><a href="the-method.html#cb42-351" tabindex="-1"></a>  resp_old <span class="ot">=</span> initial<span class="sc">$</span>resp_init</span>
<span id="cb42-352"><a href="the-method.html#cb42-352" tabindex="-1"></a>  weight_old <span class="ot">=</span> initial<span class="sc">$</span>weight_init</span>
<span id="cb42-353"><a href="the-method.html#cb42-353" tabindex="-1"></a>  resi_old <span class="ot">=</span> initial<span class="sc">$</span>resi_init</span>
<span id="cb42-354"><a href="the-method.html#cb42-354" tabindex="-1"></a>  alpha_old <span class="ot">=</span> initial<span class="sc">$</span>alpha_init</span>
<span id="cb42-355"><a href="the-method.html#cb42-355" tabindex="-1"></a>  theta0_old <span class="ot">=</span> initial<span class="sc">$</span>theta0_init</span>
<span id="cb42-356"><a href="the-method.html#cb42-356" tabindex="-1"></a>  theta_old <span class="ot">=</span> initial<span class="sc">$</span>theta_init</span>
<span id="cb42-357"><a href="the-method.html#cb42-357" tabindex="-1"></a>  g_old <span class="ot">=</span> initial<span class="sc">$</span>g_init</span>
<span id="cb42-358"><a href="the-method.html#cb42-358" tabindex="-1"></a>  Q <span class="ot">=</span> initial<span class="sc">$</span>Q</span>
<span id="cb42-359"><a href="the-method.html#cb42-359" tabindex="-1"></a>  Q_every <span class="ot">=</span> initial<span class="sc">$</span>Q_every</span>
<span id="cb42-360"><a href="the-method.html#cb42-360" tabindex="-1"></a>  </span>
<span id="cb42-361"><a href="the-method.html#cb42-361" tabindex="-1"></a>  <span class="co"># iteration</span></span>
<span id="cb42-362"><a href="the-method.html#cb42-362" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(max_iter)) {</span>
<span id="cb42-363"><a href="the-method.html#cb42-363" tabindex="-1"></a>    </span>
<span id="cb42-364"><a href="the-method.html#cb42-364" tabindex="-1"></a>    <span class="do">## E-step: update responsibilities</span></span>
<span id="cb42-365"><a href="the-method.html#cb42-365" tabindex="-1"></a>    Estep <span class="ot">=</span> <span class="fu">E_step_logcondens</span>(X, bin_mass, resi_old, alpha_old, g_old, r_bar)</span>
<span id="cb42-366"><a href="the-method.html#cb42-366" tabindex="-1"></a>    idx_new <span class="ot">=</span> Estep<span class="sc">$</span>idx</span>
<span id="cb42-367"><a href="the-method.html#cb42-367" tabindex="-1"></a>    resp_new <span class="ot">=</span> Estep<span class="sc">$</span>resp</span>
<span id="cb42-368"><a href="the-method.html#cb42-368" tabindex="-1"></a>    weight_new <span class="ot">=</span> Estep<span class="sc">$</span>weight</span>
<span id="cb42-369"><a href="the-method.html#cb42-369" tabindex="-1"></a><span class="co">#    Q_every = append(Q_every, calc_surr_logcondens(X, g_old, resi_old, theta_old, alpha_old, idx_new, weight_new, lambda_alpha, lambda_theta))</span></span>
<span id="cb42-370"><a href="the-method.html#cb42-370" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'passed Estep'</span>)</span>
<span id="cb42-371"><a href="the-method.html#cb42-371" tabindex="-1"></a>    </span>
<span id="cb42-372"><a href="the-method.html#cb42-372" tabindex="-1"></a>    <span class="do">## M-step: update estimates of (alpha,theta,g)</span></span>
<span id="cb42-373"><a href="the-method.html#cb42-373" tabindex="-1"></a>  </span>
<span id="cb42-374"><a href="the-method.html#cb42-374" tabindex="-1"></a>    <span class="do">### Mstep_alpha</span></span>
<span id="cb42-375"><a href="the-method.html#cb42-375" tabindex="-1"></a>    alpha_new <span class="ot">=</span> <span class="fu">Mstep_alpha</span>(X, weight_new, idx_new, lambda_alpha)</span>
<span id="cb42-376"><a href="the-method.html#cb42-376" tabindex="-1"></a><span class="co">#    Q_every = append(Q_every, calc_surr_logcondens(X, g_old, resi_old, theta_old, alpha_new, idx_new, weight_new, lambda_alpha, lambda_theta))</span></span>
<span id="cb42-377"><a href="the-method.html#cb42-377" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'passed alpha'</span>)</span>
<span id="cb42-378"><a href="the-method.html#cb42-378" tabindex="-1"></a>    </span>
<span id="cb42-379"><a href="the-method.html#cb42-379" tabindex="-1"></a>    <span class="do">### Mstep_theta</span></span>
<span id="cb42-380"><a href="the-method.html#cb42-380" tabindex="-1"></a>    M_theta <span class="ot">=</span> <span class="fu">Mstep_theta_logcondens</span>(Y_bin, X, weight_new, resi_old, g_old, idx_old, theta0_old, theta_old, lambda_theta, maxdev)</span>
<span id="cb42-381"><a href="the-method.html#cb42-381" tabindex="-1"></a>    theta0_new <span class="ot">=</span> M_theta<span class="sc">$</span>theta0</span>
<span id="cb42-382"><a href="the-method.html#cb42-382" tabindex="-1"></a>    theta_new <span class="ot">=</span> M_theta<span class="sc">$</span>theta</span>
<span id="cb42-383"><a href="the-method.html#cb42-383" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'passed theta'</span>)</span>
<span id="cb42-384"><a href="the-method.html#cb42-384" tabindex="-1"></a>    </span>
<span id="cb42-385"><a href="the-method.html#cb42-385" tabindex="-1"></a>    <span class="do">### Mstep_shift</span></span>
<span id="cb42-386"><a href="the-method.html#cb42-386" tabindex="-1"></a>    theta0_new <span class="ot">=</span> <span class="fu">Mstep_shift</span>(Y_bin, X, weight_new, idx_new, theta_new)</span>
<span id="cb42-387"><a href="the-method.html#cb42-387" tabindex="-1"></a>    resi_new <span class="ot">=</span> <span class="fu">calc_resi</span>(Y_bin, X, theta0_new, theta_new)</span>
<span id="cb42-388"><a href="the-method.html#cb42-388" tabindex="-1"></a><span class="co">#    Q_every = append(Q_every, calc_surr_logcondens(X, g_old, resi_new, theta_new, alpha_new, idx_new, weight_new, lambda_alpha, lambda_theta))</span></span>
<span id="cb42-389"><a href="the-method.html#cb42-389" tabindex="-1"></a>    </span>
<span id="cb42-390"><a href="the-method.html#cb42-390" tabindex="-1"></a><span class="co">#    save(resi_new, weight_new, idx_new, file = file.path('.', paste0(i, '.Rdata')))</span></span>
<span id="cb42-391"><a href="the-method.html#cb42-391" tabindex="-1"></a><span class="co">#    print(paste0(i, 'th input saved'))</span></span>
<span id="cb42-392"><a href="the-method.html#cb42-392" tabindex="-1"></a>    </span>
<span id="cb42-393"><a href="the-method.html#cb42-393" tabindex="-1"></a>    <span class="do">### Mstep_g</span></span>
<span id="cb42-394"><a href="the-method.html#cb42-394" tabindex="-1"></a>    g_new <span class="ot">=</span> <span class="fu">Mstep_g_logcondens</span>(resi_new, weight_new, idx_new)</span>
<span id="cb42-395"><a href="the-method.html#cb42-395" tabindex="-1"></a>    Q_every <span class="ot">=</span> <span class="fu">append</span>(Q_every, <span class="fu">calc_surr_logcondens</span>(X, g_new, resi_new, theta_new, alpha_new, idx_new, weight_new, lambda_alpha, lambda_theta))</span>
<span id="cb42-396"><a href="the-method.html#cb42-396" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'passed g'</span>)</span>
<span id="cb42-397"><a href="the-method.html#cb42-397" tabindex="-1"></a>    </span>
<span id="cb42-398"><a href="the-method.html#cb42-398" tabindex="-1"></a>    <span class="do">### loglikelihood</span></span>
<span id="cb42-399"><a href="the-method.html#cb42-399" tabindex="-1"></a>    Q <span class="ot">=</span> <span class="fu">append</span>(Q, Q_every[<span class="fu">length</span>(Q_every)])</span>
<span id="cb42-400"><a href="the-method.html#cb42-400" tabindex="-1"></a>    </span>
<span id="cb42-401"><a href="the-method.html#cb42-401" tabindex="-1"></a>    <span class="do">## termination criteria</span></span>
<span id="cb42-402"><a href="the-method.html#cb42-402" tabindex="-1"></a>    <span class="fu">print</span>(i)</span>
<span id="cb42-403"><a href="the-method.html#cb42-403" tabindex="-1"></a>    inc <span class="ot">=</span> (Q[i<span class="sc">+</span><span class="dv">1</span>]<span class="sc">-</span>Q[i])<span class="sc">/</span><span class="fu">abs</span>(Q[i])</span>
<span id="cb42-404"><a href="the-method.html#cb42-404" tabindex="-1"></a>    <span class="cf">if</span> (inc <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb42-405"><a href="the-method.html#cb42-405" tabindex="-1"></a>     idx_new <span class="ot">=</span> idx_old</span>
<span id="cb42-406"><a href="the-method.html#cb42-406" tabindex="-1"></a>     resp_new <span class="ot">=</span> resp_old</span>
<span id="cb42-407"><a href="the-method.html#cb42-407" tabindex="-1"></a>     resi_new <span class="ot">=</span> resi_old</span>
<span id="cb42-408"><a href="the-method.html#cb42-408" tabindex="-1"></a>     alpha_new <span class="ot">=</span> alpha_old</span>
<span id="cb42-409"><a href="the-method.html#cb42-409" tabindex="-1"></a>     theta0_new <span class="ot">=</span> theta0_old</span>
<span id="cb42-410"><a href="the-method.html#cb42-410" tabindex="-1"></a>     theta_new <span class="ot">=</span> theta_old</span>
<span id="cb42-411"><a href="the-method.html#cb42-411" tabindex="-1"></a>     weight_new <span class="ot">=</span> weight_old</span>
<span id="cb42-412"><a href="the-method.html#cb42-412" tabindex="-1"></a>     g_new <span class="ot">=</span> g_old</span>
<span id="cb42-413"><a href="the-method.html#cb42-413" tabindex="-1"></a>     <span class="fu">print</span>(<span class="st">"The loglikelihood decreased in the last iteration. Will return the previous parameters"</span>)</span>
<span id="cb42-414"><a href="the-method.html#cb42-414" tabindex="-1"></a>     <span class="cf">break</span>;</span>
<span id="cb42-415"><a href="the-method.html#cb42-415" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (inc <span class="sc">&lt;=</span> iter_eta  <span class="sc">|</span> i<span class="sc">==</span>max_iter){</span>
<span id="cb42-416"><a href="the-method.html#cb42-416" tabindex="-1"></a>      <span class="cf">break</span>;</span>
<span id="cb42-417"><a href="the-method.html#cb42-417" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb42-418"><a href="the-method.html#cb42-418" tabindex="-1"></a>      idx_old <span class="ot">=</span> idx_new</span>
<span id="cb42-419"><a href="the-method.html#cb42-419" tabindex="-1"></a>      resi_old <span class="ot">=</span> resi_new</span>
<span id="cb42-420"><a href="the-method.html#cb42-420" tabindex="-1"></a>      alpha_old <span class="ot">=</span> alpha_new</span>
<span id="cb42-421"><a href="the-method.html#cb42-421" tabindex="-1"></a>      theta0_old <span class="ot">=</span> theta0_new</span>
<span id="cb42-422"><a href="the-method.html#cb42-422" tabindex="-1"></a>      theta_old <span class="ot">=</span> theta_new</span>
<span id="cb42-423"><a href="the-method.html#cb42-423" tabindex="-1"></a>      weight_old <span class="ot">=</span> weight_new</span>
<span id="cb42-424"><a href="the-method.html#cb42-424" tabindex="-1"></a>      g_old <span class="ot">=</span> g_new</span>
<span id="cb42-425"><a href="the-method.html#cb42-425" tabindex="-1"></a>    }</span>
<span id="cb42-426"><a href="the-method.html#cb42-426" tabindex="-1"></a>  }</span>
<span id="cb42-427"><a href="the-method.html#cb42-427" tabindex="-1"></a>  <span class="fu">print</span>(i)</span>
<span id="cb42-428"><a href="the-method.html#cb42-428" tabindex="-1"></a>  </span>
<span id="cb42-429"><a href="the-method.html#cb42-429" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">idx_new =</span> idx_new,</span>
<span id="cb42-430"><a href="the-method.html#cb42-430" tabindex="-1"></a>              <span class="at">resp_new =</span> resp_new,</span>
<span id="cb42-431"><a href="the-method.html#cb42-431" tabindex="-1"></a>              <span class="at">weight_new =</span> weight_new,</span>
<span id="cb42-432"><a href="the-method.html#cb42-432" tabindex="-1"></a>              <span class="at">resi_new =</span> resi_new,</span>
<span id="cb42-433"><a href="the-method.html#cb42-433" tabindex="-1"></a>              <span class="at">alpha_new =</span> alpha_new,</span>
<span id="cb42-434"><a href="the-method.html#cb42-434" tabindex="-1"></a>              <span class="at">theta0_new =</span> theta0_new,</span>
<span id="cb42-435"><a href="the-method.html#cb42-435" tabindex="-1"></a>              <span class="at">theta_new =</span> theta_new,</span>
<span id="cb42-436"><a href="the-method.html#cb42-436" tabindex="-1"></a>              <span class="at">g_new =</span> g_new,</span>
<span id="cb42-437"><a href="the-method.html#cb42-437" tabindex="-1"></a>              <span class="at">lambda_alpha =</span> lambda_alpha, </span>
<span id="cb42-438"><a href="the-method.html#cb42-438" tabindex="-1"></a>              <span class="at">lambda_theta =</span> lambda_theta,</span>
<span id="cb42-439"><a href="the-method.html#cb42-439" tabindex="-1"></a>              <span class="at">Q =</span> Q,</span>
<span id="cb42-440"><a href="the-method.html#cb42-440" tabindex="-1"></a>              <span class="at">Q_every =</span> Q_every))</span>
<span id="cb42-441"><a href="the-method.html#cb42-441" tabindex="-1"></a>}</span>
<span id="cb42-442"><a href="the-method.html#cb42-442" tabindex="-1"></a></span>
<span id="cb42-443"><a href="the-method.html#cb42-443" tabindex="-1"></a></span>
<span id="cb42-444"><a href="the-method.html#cb42-444" tabindex="-1"></a><span class="co">#' Updating responsibility</span></span>
<span id="cb42-445"><a href="the-method.html#cb42-445" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb42-446"><a href="the-method.html#cb42-446" tabindex="-1"></a>E_step_logcondens <span class="ot">=</span> <span class="cf">function</span>(X,</span>
<span id="cb42-447"><a href="the-method.html#cb42-447" tabindex="-1"></a>                             bin_mass,</span>
<span id="cb42-448"><a href="the-method.html#cb42-448" tabindex="-1"></a>                             resi,</span>
<span id="cb42-449"><a href="the-method.html#cb42-449" tabindex="-1"></a>                             alpha,</span>
<span id="cb42-450"><a href="the-method.html#cb42-450" tabindex="-1"></a>                             g,</span>
<span id="cb42-451"><a href="the-method.html#cb42-451" tabindex="-1"></a>                             r_bar){</span>
<span id="cb42-452"><a href="the-method.html#cb42-452" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">length</span>(g)</span>
<span id="cb42-453"><a href="the-method.html#cb42-453" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">1</span>]</span>
<span id="cb42-454"><a href="the-method.html#cb42-454" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">2</span>]</span>
<span id="cb42-455"><a href="the-method.html#cb42-455" tabindex="-1"></a>  </span>
<span id="cb42-456"><a href="the-method.html#cb42-456" tabindex="-1"></a>  <span class="co"># initial clusters</span></span>
<span id="cb42-457"><a href="the-method.html#cb42-457" tabindex="-1"></a>  likeli <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-458"><a href="the-method.html#cb42-458" tabindex="-1"></a>  resp <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-459"><a href="the-method.html#cb42-459" tabindex="-1"></a>  weight <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-460"><a href="the-method.html#cb42-460" tabindex="-1"></a>  idx <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-461"><a href="the-method.html#cb42-461" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb42-462"><a href="the-method.html#cb42-462" tabindex="-1"></a>    likeli[[t]] <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(resi[[t]]), <span class="at">ncol =</span> K)</span>
<span id="cb42-463"><a href="the-method.html#cb42-463" tabindex="-1"></a>    idx[[t]] <span class="ot">=</span> <span class="fu">matrix</span>(F, <span class="at">nrow =</span> <span class="fu">nrow</span>(resi[[t]]), <span class="at">ncol =</span> K)</span>
<span id="cb42-464"><a href="the-method.html#cb42-464" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb42-465"><a href="the-method.html#cb42-465" tabindex="-1"></a>      <span class="fu">suppressWarnings</span>({likeli[[t]][,k] <span class="ot">=</span> logcondens<span class="sc">::</span><span class="fu">evaluateLogConDens</span>(resi[[t]][,k], g[[k]])[,<span class="dv">3</span>] <span class="sc">*</span> <span class="fu">pi_k</span>(X, alpha)[t,k]})</span>
<span id="cb42-466"><a href="the-method.html#cb42-466" tabindex="-1"></a>    }</span>
<span id="cb42-467"><a href="the-method.html#cb42-467" tabindex="-1"></a>    resp[[t]] <span class="ot">=</span> likeli[[t]]<span class="sc">/</span><span class="fu">rowSums</span>(likeli[[t]])</span>
<span id="cb42-468"><a href="the-method.html#cb42-468" tabindex="-1"></a>    idx[[t]] <span class="ot">=</span> resp[[t]] <span class="sc">&gt;</span> r_bar     </span>
<span id="cb42-469"><a href="the-method.html#cb42-469" tabindex="-1"></a>    weight[[t]] <span class="ot">=</span> resp[[t]] <span class="sc">*</span> bin_mass[[t]]</span>
<span id="cb42-470"><a href="the-method.html#cb42-470" tabindex="-1"></a>  }</span>
<span id="cb42-471"><a href="the-method.html#cb42-471" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">resp =</span> resp,</span>
<span id="cb42-472"><a href="the-method.html#cb42-472" tabindex="-1"></a>              <span class="at">weight =</span> weight,</span>
<span id="cb42-473"><a href="the-method.html#cb42-473" tabindex="-1"></a>              <span class="at">idx =</span> idx</span>
<span id="cb42-474"><a href="the-method.html#cb42-474" tabindex="-1"></a>              ))</span>
<span id="cb42-475"><a href="the-method.html#cb42-475" tabindex="-1"></a>}</span>
<span id="cb42-476"><a href="the-method.html#cb42-476" tabindex="-1"></a></span>
<span id="cb42-477"><a href="the-method.html#cb42-477" tabindex="-1"></a></span>
<span id="cb42-478"><a href="the-method.html#cb42-478" tabindex="-1"></a></span>
<span id="cb42-479"><a href="the-method.html#cb42-479" tabindex="-1"></a></span>
<span id="cb42-480"><a href="the-method.html#cb42-480" tabindex="-1"></a><span class="co">#' updating alpha</span></span>
<span id="cb42-481"><a href="the-method.html#cb42-481" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb42-482"><a href="the-method.html#cb42-482" tabindex="-1"></a>Mstep_alpha <span class="ot">=</span> <span class="cf">function</span>(X,</span>
<span id="cb42-483"><a href="the-method.html#cb42-483" tabindex="-1"></a>                       weight,</span>
<span id="cb42-484"><a href="the-method.html#cb42-484" tabindex="-1"></a>                       idx,</span>
<span id="cb42-485"><a href="the-method.html#cb42-485" tabindex="-1"></a>                       lambda_alpha){</span>
<span id="cb42-486"><a href="the-method.html#cb42-486" tabindex="-1"></a>  </span>
<span id="cb42-487"><a href="the-method.html#cb42-487" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">1</span>]</span>
<span id="cb42-488"><a href="the-method.html#cb42-488" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">dim</span>(idx[[<span class="dv">1</span>]])[<span class="dv">2</span>]</span>
<span id="cb42-489"><a href="the-method.html#cb42-489" tabindex="-1"></a>  lambda_max <span class="ot">=</span> lambda_alpha <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb42-490"><a href="the-method.html#cb42-490" tabindex="-1"></a>  lambdas <span class="ot">=</span> <span class="fu">exp</span>(<span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">log</span>(lambda_max), <span class="at">to =</span> <span class="fu">log</span>(lambda_alpha), <span class="at">length =</span> <span class="dv">30</span>))</span>
<span id="cb42-491"><a href="the-method.html#cb42-491" tabindex="-1"></a>  </span>
<span id="cb42-492"><a href="the-method.html#cb42-492" tabindex="-1"></a>  weight.sum <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT, <span class="at">ncol =</span> K)</span>
<span id="cb42-493"><a href="the-method.html#cb42-493" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb42-494"><a href="the-method.html#cb42-494" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb42-495"><a href="the-method.html#cb42-495" tabindex="-1"></a>      idx_tk <span class="ot">=</span> idx[[t]][,k]</span>
<span id="cb42-496"><a href="the-method.html#cb42-496" tabindex="-1"></a>      weight.sum[t,k] <span class="ot">=</span> <span class="fu">sum</span>(weight[[t]][idx_tk,k])</span>
<span id="cb42-497"><a href="the-method.html#cb42-497" tabindex="-1"></a>    }</span>
<span id="cb42-498"><a href="the-method.html#cb42-498" tabindex="-1"></a>  }</span>
<span id="cb42-499"><a href="the-method.html#cb42-499" tabindex="-1"></a>  fit <span class="ot">=</span> glmnet<span class="sc">::</span><span class="fu">glmnet</span>(<span class="at">x =</span> X,</span>
<span id="cb42-500"><a href="the-method.html#cb42-500" tabindex="-1"></a>                        <span class="at">y =</span> weight.sum,</span>
<span id="cb42-501"><a href="the-method.html#cb42-501" tabindex="-1"></a>                        <span class="at">lambda =</span> lambdas,</span>
<span id="cb42-502"><a href="the-method.html#cb42-502" tabindex="-1"></a>                        <span class="at">family =</span> <span class="st">"multinomial"</span>,</span>
<span id="cb42-503"><a href="the-method.html#cb42-503" tabindex="-1"></a>                        <span class="at">intercept =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-504"><a href="the-method.html#cb42-504" tabindex="-1"></a>  coefs <span class="ot">=</span> glmnet<span class="sc">::</span><span class="fu">coef.glmnet</span>(fit, <span class="at">s =</span> lambda_alpha)</span>
<span id="cb42-505"><a href="the-method.html#cb42-505" tabindex="-1"></a>  alpha <span class="ot">=</span> <span class="fu">t</span>(<span class="fu">as.matrix</span>(<span class="fu">do.call</span>(cbind, coefs)))</span>
<span id="cb42-506"><a href="the-method.html#cb42-506" tabindex="-1"></a>  <span class="fu">return</span>(alpha)  <span class="co"># (p+1) by K matrix</span></span>
<span id="cb42-507"><a href="the-method.html#cb42-507" tabindex="-1"></a>}</span>
<span id="cb42-508"><a href="the-method.html#cb42-508" tabindex="-1"></a></span>
<span id="cb42-509"><a href="the-method.html#cb42-509" tabindex="-1"></a></span>
<span id="cb42-510"><a href="the-method.html#cb42-510" tabindex="-1"></a></span>
<span id="cb42-511"><a href="the-method.html#cb42-511" tabindex="-1"></a></span>
<span id="cb42-512"><a href="the-method.html#cb42-512" tabindex="-1"></a><span class="co">#' Updating theta</span></span>
<span id="cb42-513"><a href="the-method.html#cb42-513" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb42-514"><a href="the-method.html#cb42-514" tabindex="-1"></a>Mstep_theta_logcondens <span class="ot">=</span> <span class="cf">function</span>(Y_bin,</span>
<span id="cb42-515"><a href="the-method.html#cb42-515" tabindex="-1"></a>                                  X,</span>
<span id="cb42-516"><a href="the-method.html#cb42-516" tabindex="-1"></a>                                  weight,</span>
<span id="cb42-517"><a href="the-method.html#cb42-517" tabindex="-1"></a>                                  resi,</span>
<span id="cb42-518"><a href="the-method.html#cb42-518" tabindex="-1"></a>                                  g,</span>
<span id="cb42-519"><a href="the-method.html#cb42-519" tabindex="-1"></a>                                  idx_old,</span>
<span id="cb42-520"><a href="the-method.html#cb42-520" tabindex="-1"></a>                                  theta0,</span>
<span id="cb42-521"><a href="the-method.html#cb42-521" tabindex="-1"></a>                                  theta,</span>
<span id="cb42-522"><a href="the-method.html#cb42-522" tabindex="-1"></a>                                  lambda_theta,</span>
<span id="cb42-523"><a href="the-method.html#cb42-523" tabindex="-1"></a>                                  maxdev){</span>
<span id="cb42-524"><a href="the-method.html#cb42-524" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">length</span>(g)</span>
<span id="cb42-525"><a href="the-method.html#cb42-525" tabindex="-1"></a>  theta0_new <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-526"><a href="the-method.html#cb42-526" tabindex="-1"></a>  theta_new <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-527"><a href="the-method.html#cb42-527" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb42-528"><a href="the-method.html#cb42-528" tabindex="-1"></a>    tmp <span class="ot">=</span> <span class="fu">LP_logcondens</span>(Y_bin, X, weight, resi, g[[k]], idx_old, theta0[[k]], theta[[k]], lambda_theta, k, maxdev)</span>
<span id="cb42-529"><a href="the-method.html#cb42-529" tabindex="-1"></a>    theta0_new[[k]] <span class="ot">=</span> tmp<span class="sc">$</span>theta0_k</span>
<span id="cb42-530"><a href="the-method.html#cb42-530" tabindex="-1"></a>    theta_new[[k]] <span class="ot">=</span> tmp<span class="sc">$</span>theta_k</span>
<span id="cb42-531"><a href="the-method.html#cb42-531" tabindex="-1"></a>  }</span>
<span id="cb42-532"><a href="the-method.html#cb42-532" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">'theta0'</span> <span class="ot">=</span> theta0_new , <span class="st">'theta'</span> <span class="ot">=</span> theta_new ))</span>
<span id="cb42-533"><a href="the-method.html#cb42-533" tabindex="-1"></a>}</span>
<span id="cb42-534"><a href="the-method.html#cb42-534" tabindex="-1"></a></span>
<span id="cb42-535"><a href="the-method.html#cb42-535" tabindex="-1"></a></span>
<span id="cb42-536"><a href="the-method.html#cb42-536" tabindex="-1"></a></span>
<span id="cb42-537"><a href="the-method.html#cb42-537" tabindex="-1"></a><span class="co">#' Updating theta for each k (switching i and j)</span></span>
<span id="cb42-538"><a href="the-method.html#cb42-538" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb42-539"><a href="the-method.html#cb42-539" tabindex="-1"></a>LP_logcondens <span class="ot">=</span> <span class="cf">function</span>(Y_bin,</span>
<span id="cb42-540"><a href="the-method.html#cb42-540" tabindex="-1"></a>                         X,</span>
<span id="cb42-541"><a href="the-method.html#cb42-541" tabindex="-1"></a>                         weight,</span>
<span id="cb42-542"><a href="the-method.html#cb42-542" tabindex="-1"></a>                         resi,</span>
<span id="cb42-543"><a href="the-method.html#cb42-543" tabindex="-1"></a>                         g_k,</span>
<span id="cb42-544"><a href="the-method.html#cb42-544" tabindex="-1"></a>                         idx,</span>
<span id="cb42-545"><a href="the-method.html#cb42-545" tabindex="-1"></a>                         theta0_k,</span>
<span id="cb42-546"><a href="the-method.html#cb42-546" tabindex="-1"></a>                         theta_k,</span>
<span id="cb42-547"><a href="the-method.html#cb42-547" tabindex="-1"></a>                         lambda_theta,</span>
<span id="cb42-548"><a href="the-method.html#cb42-548" tabindex="-1"></a>                         k,</span>
<span id="cb42-549"><a href="the-method.html#cb42-549" tabindex="-1"></a>                         maxdev){</span>
<span id="cb42-550"><a href="the-method.html#cb42-550" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">length</span>(Y_bin)</span>
<span id="cb42-551"><a href="the-method.html#cb42-551" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(weight))</span>
<span id="cb42-552"><a href="the-method.html#cb42-552" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">dim</span>(X)[<span class="dv">2</span>]</span>
<span id="cb42-553"><a href="the-method.html#cb42-553" tabindex="-1"></a>  resi_k <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-554"><a href="the-method.html#cb42-554" tabindex="-1"></a>  w_k <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-555"><a href="the-method.html#cb42-555" tabindex="-1"></a>  idx_k <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-556"><a href="the-method.html#cb42-556" tabindex="-1"></a>  Y_idx <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-557"><a href="the-method.html#cb42-557" tabindex="-1"></a>  X_idx <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-558"><a href="the-method.html#cb42-558" tabindex="-1"></a>  n_to_skip <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-559"><a href="the-method.html#cb42-559" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb42-560"><a href="the-method.html#cb42-560" tabindex="-1"></a>    idx_tk <span class="ot">=</span> idx[[t]][,k]</span>
<span id="cb42-561"><a href="the-method.html#cb42-561" tabindex="-1"></a>    nt <span class="ot">=</span> <span class="fu">sum</span>(idx_tk)</span>
<span id="cb42-562"><a href="the-method.html#cb42-562" tabindex="-1"></a>    <span class="cf">if</span> (nt <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb42-563"><a href="the-method.html#cb42-563" tabindex="-1"></a>      idx_k <span class="ot">=</span> <span class="fu">c</span>(idx_k, idx_tk)</span>
<span id="cb42-564"><a href="the-method.html#cb42-564" tabindex="-1"></a>      resi_k <span class="ot">=</span> <span class="fu">c</span>(resi_k, resi[[t]][idx_tk,k])</span>
<span id="cb42-565"><a href="the-method.html#cb42-565" tabindex="-1"></a>      w_k <span class="ot">=</span> <span class="fu">c</span>(w_k, weight[[t]][idx_tk,k])</span>
<span id="cb42-566"><a href="the-method.html#cb42-566" tabindex="-1"></a>      Y_idx <span class="ot">=</span> <span class="fu">c</span>(Y_idx, Y_bin[[t]][idx_tk,])</span>
<span id="cb42-567"><a href="the-method.html#cb42-567" tabindex="-1"></a>      X_t <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(X[t,], nt), <span class="at">byrow =</span> T, <span class="at">ncol =</span> p)</span>
<span id="cb42-568"><a href="the-method.html#cb42-568" tabindex="-1"></a>      X_idx <span class="ot">=</span> <span class="fu">rbind</span>(X_idx, X_t)</span>
<span id="cb42-569"><a href="the-method.html#cb42-569" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb42-570"><a href="the-method.html#cb42-570" tabindex="-1"></a>      n_to_skip <span class="ot">=</span> <span class="fu">c</span>(n_to_skip, t)</span>
<span id="cb42-571"><a href="the-method.html#cb42-571" tabindex="-1"></a>    } </span>
<span id="cb42-572"><a href="the-method.html#cb42-572" tabindex="-1"></a>  }</span>
<span id="cb42-573"><a href="the-method.html#cb42-573" tabindex="-1"></a>  n <span class="ot">=</span> <span class="fu">length</span>(Y_idx) <span class="co"># the number of points in C_n</span></span>
<span id="cb42-574"><a href="the-method.html#cb42-574" tabindex="-1"></a>  </span>
<span id="cb42-575"><a href="the-method.html#cb42-575" tabindex="-1"></a>  x_m <span class="ot">=</span> g_k<span class="sc">$</span>x[<span class="fu">as.logical</span>(g_k<span class="sc">$</span>IsKnot)]</span>
<span id="cb42-576"><a href="the-method.html#cb42-576" tabindex="-1"></a>  phi_m <span class="ot">=</span> g_k<span class="sc">$</span>phi[<span class="fu">as.logical</span>(g_k<span class="sc">$</span>IsKnot)]</span>
<span id="cb42-577"><a href="the-method.html#cb42-577" tabindex="-1"></a>  J <span class="ot">=</span> <span class="fu">length</span>(x_m) <span class="sc">-</span> <span class="dv">1</span> <span class="co"># the number of affine functions</span></span>
<span id="cb42-578"><a href="the-method.html#cb42-578" tabindex="-1"></a>  beta <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, J)</span>
<span id="cb42-579"><a href="the-method.html#cb42-579" tabindex="-1"></a>  b <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, J)</span>
<span id="cb42-580"><a href="the-method.html#cb42-580" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>J){</span>
<span id="cb42-581"><a href="the-method.html#cb42-581" tabindex="-1"></a>    b[j] <span class="ot">=</span> (phi_m[j<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> phi_m[j])<span class="sc">/</span>(x_m[j<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> x_m[j])</span>
<span id="cb42-582"><a href="the-method.html#cb42-582" tabindex="-1"></a>    beta[j] <span class="ot">=</span> b[j] <span class="sc">*</span> x_m[j] <span class="sc">-</span> phi_m[j]</span>
<span id="cb42-583"><a href="the-method.html#cb42-583" tabindex="-1"></a>  }</span>
<span id="cb42-584"><a href="the-method.html#cb42-584" tabindex="-1"></a>   </span>
<span id="cb42-585"><a href="the-method.html#cb42-585" tabindex="-1"></a>  L <span class="ot">=</span> <span class="fu">min</span>(resi_k)</span>
<span id="cb42-586"><a href="the-method.html#cb42-586" tabindex="-1"></a>  U <span class="ot">=</span> <span class="fu">max</span>(resi_k) </span>
<span id="cb42-587"><a href="the-method.html#cb42-587" tabindex="-1"></a>  const_mat <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-588"><a href="the-method.html#cb42-588" tabindex="-1"></a>  const_vec <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-589"><a href="the-method.html#cb42-589" tabindex="-1"></a>  </span>
<span id="cb42-590"><a href="the-method.html#cb42-590" tabindex="-1"></a>  <span class="co"># epigraph part</span></span>
<span id="cb42-591"><a href="the-method.html#cb42-591" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>J){</span>
<span id="cb42-592"><a href="the-method.html#cb42-592" tabindex="-1"></a>    tmp <span class="ot">=</span> <span class="fu">cbind</span>(Matrix<span class="sc">::</span><span class="fu">Diagonal</span>(n), b[j], b[j]<span class="sc">*</span>X_idx)</span>
<span id="cb42-593"><a href="the-method.html#cb42-593" tabindex="-1"></a>    const_mat <span class="ot">=</span> <span class="fu">rbind</span>(const_mat, <span class="fu">cbind</span>(tmp, <span class="sc">-</span>tmp))</span>
<span id="cb42-594"><a href="the-method.html#cb42-594" tabindex="-1"></a>    const_vec <span class="ot">=</span> <span class="fu">c</span>(const_vec, b[j]<span class="sc">*</span>Y_idx<span class="sc">-</span>beta[j])</span>
<span id="cb42-595"><a href="the-method.html#cb42-595" tabindex="-1"></a>  }</span>
<span id="cb42-596"><a href="the-method.html#cb42-596" tabindex="-1"></a>  </span>
<span id="cb42-597"><a href="the-method.html#cb42-597" tabindex="-1"></a>  <span class="co"># feasibility part</span></span>
<span id="cb42-598"><a href="the-method.html#cb42-598" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(n_to_skip) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb42-599"><a href="the-method.html#cb42-599" tabindex="-1"></a>    TT_new <span class="ot">=</span> TT</span>
<span id="cb42-600"><a href="the-method.html#cb42-600" tabindex="-1"></a>    X_new <span class="ot">=</span> X</span>
<span id="cb42-601"><a href="the-method.html#cb42-601" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb42-602"><a href="the-method.html#cb42-602" tabindex="-1"></a>    TT_new <span class="ot">=</span> TT <span class="sc">-</span> <span class="fu">length</span>(n_to_skip)</span>
<span id="cb42-603"><a href="the-method.html#cb42-603" tabindex="-1"></a>    X_new <span class="ot">=</span> X[<span class="sc">-</span>n_to_skip,]</span>
<span id="cb42-604"><a href="the-method.html#cb42-604" tabindex="-1"></a>  }</span>
<span id="cb42-605"><a href="the-method.html#cb42-605" tabindex="-1"></a>  tmp <span class="ot">=</span> <span class="fu">cbind</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT_new, <span class="at">ncol =</span> n), <span class="fu">matrix</span>(<span class="dv">1</span>, <span class="at">nrow =</span> TT_new, <span class="at">ncol =</span> <span class="dv">1</span>), X_new)</span>
<span id="cb42-606"><a href="the-method.html#cb42-606" tabindex="-1"></a>  const_mat <span class="ot">=</span> <span class="fu">rbind</span>(const_mat, <span class="fu">cbind</span>(tmp, <span class="sc">-</span>tmp), <span class="fu">cbind</span>(<span class="sc">-</span>tmp, tmp))</span>
<span id="cb42-607"><a href="the-method.html#cb42-607" tabindex="-1"></a>  </span>
<span id="cb42-608"><a href="the-method.html#cb42-608" tabindex="-1"></a>  tmp <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">2</span><span class="sc">*</span>TT_new)</span>
<span id="cb42-609"><a href="the-method.html#cb42-609" tabindex="-1"></a>  count <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb42-610"><a href="the-method.html#cb42-610" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb42-611"><a href="the-method.html#cb42-611" tabindex="-1"></a>    idx_tk <span class="ot">=</span> idx[[t]][,k]</span>
<span id="cb42-612"><a href="the-method.html#cb42-612" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(idx_tk) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb42-613"><a href="the-method.html#cb42-613" tabindex="-1"></a>      tmp[count] <span class="ot">=</span> <span class="fu">min</span>(Y_bin[[t]][idx_tk])<span class="sc">-</span> L</span>
<span id="cb42-614"><a href="the-method.html#cb42-614" tabindex="-1"></a>      tmp[TT_new <span class="sc">+</span> count] <span class="ot">=</span> U <span class="sc">-</span> <span class="fu">max</span>(Y_bin[[t]][idx_tk])</span>
<span id="cb42-615"><a href="the-method.html#cb42-615" tabindex="-1"></a>      count <span class="ot">=</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb42-616"><a href="the-method.html#cb42-616" tabindex="-1"></a>    }</span>
<span id="cb42-617"><a href="the-method.html#cb42-617" tabindex="-1"></a>  }</span>
<span id="cb42-618"><a href="the-method.html#cb42-618" tabindex="-1"></a>  const_vec <span class="ot">=</span> <span class="fu">c</span>(const_vec, tmp)</span>
<span id="cb42-619"><a href="the-method.html#cb42-619" tabindex="-1"></a>  </span>
<span id="cb42-620"><a href="the-method.html#cb42-620" tabindex="-1"></a><span class="co">#  print(dim(const_mat))</span></span>
<span id="cb42-621"><a href="the-method.html#cb42-621" tabindex="-1"></a><span class="co">#  print(format(object.size(const_mat), "Mb"))</span></span>
<span id="cb42-622"><a href="the-method.html#cb42-622" tabindex="-1"></a>  </span>
<span id="cb42-623"><a href="the-method.html#cb42-623" tabindex="-1"></a>  obj_coef <span class="ot">=</span> <span class="fu">c</span>(w_k, <span class="dv">0</span>, <span class="fu">rep</span>(<span class="sc">-</span>N<span class="sc">*</span>lambda_theta, p), <span class="sc">-</span>w_k, <span class="dv">0</span>, <span class="fu">rep</span>(<span class="sc">-</span>N<span class="sc">*</span>lambda_theta, p))</span>
<span id="cb42-624"><a href="the-method.html#cb42-624" tabindex="-1"></a>  const_dir <span class="ot">=</span> <span class="fu">rep</span>(<span class="st">"&lt;="</span>, J<span class="sc">*</span>n <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>TT_new)</span>
<span id="cb42-625"><a href="the-method.html#cb42-625" tabindex="-1"></a>  </span>
<span id="cb42-626"><a href="the-method.html#cb42-626" tabindex="-1"></a>  </span>
<span id="cb42-627"><a href="the-method.html#cb42-627" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(maxdev)) {</span>
<span id="cb42-628"><a href="the-method.html#cb42-628" tabindex="-1"></a>    tmp <span class="ot">=</span> <span class="fu">cbind</span>(<span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> TT_new, <span class="at">ncol =</span> n<span class="sc">+</span><span class="dv">1</span>), X_new)</span>
<span id="cb42-629"><a href="the-method.html#cb42-629" tabindex="-1"></a>    const_mat <span class="ot">=</span> <span class="fu">rbind</span>(const_mat, <span class="fu">cbind</span>(tmp, <span class="sc">-</span>tmp), <span class="fu">cbind</span>(<span class="sc">-</span>tmp, tmp))</span>
<span id="cb42-630"><a href="the-method.html#cb42-630" tabindex="-1"></a>    const_vec <span class="ot">=</span> <span class="fu">c</span>(const_vec, <span class="fu">rep</span>(maxdev, <span class="dv">2</span><span class="sc">*</span>TT_new))</span>
<span id="cb42-631"><a href="the-method.html#cb42-631" tabindex="-1"></a>    const_dir <span class="ot">=</span> <span class="fu">c</span>(const_dir, <span class="fu">rep</span>(<span class="st">"&lt;="</span>, <span class="dv">2</span><span class="sc">*</span>TT_new))</span>
<span id="cb42-632"><a href="the-method.html#cb42-632" tabindex="-1"></a>  }</span>
<span id="cb42-633"><a href="the-method.html#cb42-633" tabindex="-1"></a>  </span>
<span id="cb42-634"><a href="the-method.html#cb42-634" tabindex="-1"></a>  <span class="co"># solving LP</span></span>
<span id="cb42-635"><a href="the-method.html#cb42-635" tabindex="-1"></a>  lp_res <span class="ot">=</span> lpSolve<span class="sc">::</span><span class="fu">lp</span>(<span class="at">obj =</span> obj_coef, <span class="at">const.mat =</span> const_mat, <span class="at">const.dir =</span> const_dir, <span class="at">const.rhs =</span> const_vec,  <span class="at">direction =</span> <span class="st">"max"</span>)</span>
<span id="cb42-636"><a href="the-method.html#cb42-636" tabindex="-1"></a>  <span class="cf">if</span> (lp_res<span class="sc">$</span>status <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb42-637"><a href="the-method.html#cb42-637" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">"No solution has been stored by Rsymphony. Change the LP solver to lpSolve"</span>)</span>
<span id="cb42-638"><a href="the-method.html#cb42-638" tabindex="-1"></a>  }</span>
<span id="cb42-639"><a href="the-method.html#cb42-639" tabindex="-1"></a>  theta0_k <span class="ot">=</span> lp_res<span class="sc">$</span>solution[n<span class="sc">+</span><span class="dv">1</span>] <span class="sc">-</span> lp_res<span class="sc">$</span>solution[<span class="dv">2</span><span class="sc">*</span>n<span class="sc">+</span>p<span class="sc">+</span><span class="dv">2</span>]</span>
<span id="cb42-640"><a href="the-method.html#cb42-640" tabindex="-1"></a>  theta_k <span class="ot">=</span> lp_res<span class="sc">$</span>solution[(n<span class="sc">+</span><span class="dv">2</span>)<span class="sc">:</span>(n<span class="sc">+</span>p<span class="sc">+</span><span class="dv">1</span>)] <span class="sc">-</span> lp_res<span class="sc">$</span>solution[(<span class="dv">2</span><span class="sc">*</span>n<span class="sc">+</span>p<span class="sc">+</span><span class="dv">3</span>)<span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span>(n<span class="sc">+</span>p<span class="sc">+</span><span class="dv">1</span>))]</span>
<span id="cb42-641"><a href="the-method.html#cb42-641" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">theta0_k =</span> theta0_k, <span class="at">theta_k =</span> theta_k)) <span class="co">#theta</span></span>
<span id="cb42-642"><a href="the-method.html#cb42-642" tabindex="-1"></a>}</span>
<span id="cb42-643"><a href="the-method.html#cb42-643" tabindex="-1"></a></span>
<span id="cb42-644"><a href="the-method.html#cb42-644" tabindex="-1"></a></span>
<span id="cb42-645"><a href="the-method.html#cb42-645" tabindex="-1"></a></span>
<span id="cb42-646"><a href="the-method.html#cb42-646" tabindex="-1"></a>L1_diff <span class="ot">=</span> <span class="cf">function</span>(true, est){</span>
<span id="cb42-647"><a href="the-method.html#cb42-647" tabindex="-1"></a>  diff1 <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">abs</span>(true <span class="sc">-</span> est))</span>
<span id="cb42-648"><a href="the-method.html#cb42-648" tabindex="-1"></a>  diff2 <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">abs</span>(true[,<span class="dv">1</span>] <span class="sc">-</span> est[,<span class="dv">2</span>]) <span class="sc">+</span> <span class="fu">abs</span>(true[,<span class="dv">2</span>] <span class="sc">-</span> est[,<span class="dv">1</span>]))</span>
<span id="cb42-649"><a href="the-method.html#cb42-649" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">min</span>(diff1, diff2))</span>
<span id="cb42-650"><a href="the-method.html#cb42-650" tabindex="-1"></a>}</span>
<span id="cb42-651"><a href="the-method.html#cb42-651" tabindex="-1"></a></span>
<span id="cb42-652"><a href="the-method.html#cb42-652" tabindex="-1"></a></span>
<span id="cb42-653"><a href="the-method.html#cb42-653" tabindex="-1"></a>isIncreasing <span class="ot">=</span> <span class="cf">function</span>(v){</span>
<span id="cb42-654"><a href="the-method.html#cb42-654" tabindex="-1"></a>  n <span class="ot">=</span> <span class="fu">length</span>(v)</span>
<span id="cb42-655"><a href="the-method.html#cb42-655" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n){</span>
<span id="cb42-656"><a href="the-method.html#cb42-656" tabindex="-1"></a>    <span class="cf">if</span> (v[i] <span class="sc">&lt;</span> v[i<span class="dv">-1</span>]) {</span>
<span id="cb42-657"><a href="the-method.html#cb42-657" tabindex="-1"></a>      <span class="fu">return</span>(F)</span>
<span id="cb42-658"><a href="the-method.html#cb42-658" tabindex="-1"></a>    } </span>
<span id="cb42-659"><a href="the-method.html#cb42-659" tabindex="-1"></a>  }</span>
<span id="cb42-660"><a href="the-method.html#cb42-660" tabindex="-1"></a>  <span class="fu">return</span>(T)</span>
<span id="cb42-661"><a href="the-method.html#cb42-661" tabindex="-1"></a>}</span>
<span id="cb42-662"><a href="the-method.html#cb42-662" tabindex="-1"></a></span>
<span id="cb42-663"><a href="the-method.html#cb42-663" tabindex="-1"></a>weightedHist <span class="ot">=</span> <span class="cf">function</span>(g_k, <span class="at">B =</span> <span class="dv">30</span>){</span>
<span id="cb42-664"><a href="the-method.html#cb42-664" tabindex="-1"></a>  minY <span class="ot">=</span> <span class="fu">min</span>(g_k<span class="sc">$</span>xn)</span>
<span id="cb42-665"><a href="the-method.html#cb42-665" tabindex="-1"></a>  maxY <span class="ot">=</span> <span class="fu">max</span>(g_k<span class="sc">$</span>xn)</span>
<span id="cb42-666"><a href="the-method.html#cb42-666" tabindex="-1"></a>  bin <span class="ot">=</span> <span class="fu">seq</span>(<span class="at">from=</span>minY, <span class="at">to=</span>maxY, <span class="at">length=</span> B <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb42-667"><a href="the-method.html#cb42-667" tabindex="-1"></a>  binnedY <span class="ot">=</span> <span class="fu">findInterval</span>(g_k<span class="sc">$</span>xn, bin, <span class="at">rightmost.closed =</span> T)</span>
<span id="cb42-668"><a href="the-method.html#cb42-668" tabindex="-1"></a>  binnedY <span class="ot">=</span> <span class="fu">factor</span>(binnedY, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span>B)</span>
<span id="cb42-669"><a href="the-method.html#cb42-669" tabindex="-1"></a>  w <span class="ot">=</span> <span class="fu">tapply</span>(g_k<span class="sc">$</span>w, binnedY , sum)</span>
<span id="cb42-670"><a href="the-method.html#cb42-670" tabindex="-1"></a>  w[<span class="fu">is.na</span>(w)] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb42-671"><a href="the-method.html#cb42-671" tabindex="-1"></a>  w <span class="ot">=</span> w <span class="sc">*</span> B <span class="sc">/</span>(<span class="fu">sum</span>(w) <span class="sc">*</span>(maxY<span class="sc">-</span>minY))</span>
<span id="cb42-672"><a href="the-method.html#cb42-672" tabindex="-1"></a>  </span>
<span id="cb42-673"><a href="the-method.html#cb42-673" tabindex="-1"></a>  mid <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, B)</span>
<span id="cb42-674"><a href="the-method.html#cb42-674" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){mid[i] <span class="ot">=</span> (bin[i<span class="sc">+</span><span class="dv">1</span>] <span class="sc">+</span> bin[i])<span class="sc">/</span><span class="dv">2</span>}</span>
<span id="cb42-675"><a href="the-method.html#cb42-675" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">mid =</span> mid,</span>
<span id="cb42-676"><a href="the-method.html#cb42-676" tabindex="-1"></a>              <span class="at">w =</span> w))</span>
<span id="cb42-677"><a href="the-method.html#cb42-677" tabindex="-1"></a>}</span>
<span id="cb42-678"><a href="the-method.html#cb42-678" tabindex="-1"></a></span>
<span id="cb42-679"><a href="the-method.html#cb42-679" tabindex="-1"></a>weighted_quantile <span class="ot">=</span> <span class="cf">function</span>(x, w, <span class="at">thr =</span> <span class="fl">0.05</span>){</span>
<span id="cb42-680"><a href="the-method.html#cb42-680" tabindex="-1"></a>  mat <span class="ot">=</span> <span class="fu">cbind</span>(x, w)</span>
<span id="cb42-681"><a href="the-method.html#cb42-681" tabindex="-1"></a>  mat <span class="ot">=</span> mat[<span class="fu">order</span>(x),]</span>
<span id="cb42-682"><a href="the-method.html#cb42-682" tabindex="-1"></a>  thr <span class="ot">=</span> thr <span class="sc">*</span> <span class="fu">sum</span>(w)</span>
<span id="cb42-683"><a href="the-method.html#cb42-683" tabindex="-1"></a>  tot <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb42-684"><a href="the-method.html#cb42-684" tabindex="-1"></a>  i <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb42-685"><a href="the-method.html#cb42-685" tabindex="-1"></a>  <span class="cf">while</span> (i <span class="sc">&lt;</span> <span class="fu">length</span>(w) <span class="sc">&amp;</span> tot <span class="sc">&lt;</span> thr){</span>
<span id="cb42-686"><a href="the-method.html#cb42-686" tabindex="-1"></a>    tot <span class="ot">=</span> tot <span class="sc">+</span> w[i]</span>
<span id="cb42-687"><a href="the-method.html#cb42-687" tabindex="-1"></a>    i <span class="ot">=</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb42-688"><a href="the-method.html#cb42-688" tabindex="-1"></a>  }</span>
<span id="cb42-689"><a href="the-method.html#cb42-689" tabindex="-1"></a>  <span class="fu">return</span>(mat[i,<span class="dv">1</span>])</span>
<span id="cb42-690"><a href="the-method.html#cb42-690" tabindex="-1"></a>}</span>
<span id="cb42-691"><a href="the-method.html#cb42-691" tabindex="-1"></a></span>
<span id="cb42-692"><a href="the-method.html#cb42-692" tabindex="-1"></a></span>
<span id="cb42-693"><a href="the-method.html#cb42-693" tabindex="-1"></a>eval_LCD <span class="ot">=</span> <span class="cf">function</span>(LCDmix,</span>
<span id="cb42-694"><a href="the-method.html#cb42-694" tabindex="-1"></a>                    Y_new,</span>
<span id="cb42-695"><a href="the-method.html#cb42-695" tabindex="-1"></a>                    X_new,</span>
<span id="cb42-696"><a href="the-method.html#cb42-696" tabindex="-1"></a>                    biomass_new, </span>
<span id="cb42-697"><a href="the-method.html#cb42-697" tabindex="-1"></a>                    <span class="at">trim_thr =</span> <span class="fl">0.05</span>){</span>
<span id="cb42-698"><a href="the-method.html#cb42-698" tabindex="-1"></a>  g <span class="ot">=</span> LCDmix<span class="sc">$</span>g_new</span>
<span id="cb42-699"><a href="the-method.html#cb42-699" tabindex="-1"></a>  theta <span class="ot">=</span> LCDmix<span class="sc">$</span>theta_new</span>
<span id="cb42-700"><a href="the-method.html#cb42-700" tabindex="-1"></a>  theta0 <span class="ot">=</span> LCDmix<span class="sc">$</span>theta0_new</span>
<span id="cb42-701"><a href="the-method.html#cb42-701" tabindex="-1"></a>  alpha <span class="ot">=</span> LCDmix<span class="sc">$</span>alpha_new</span>
<span id="cb42-702"><a href="the-method.html#cb42-702" tabindex="-1"></a>  resp <span class="ot">=</span> LCDmix<span class="sc">$</span>resp_new</span>
<span id="cb42-703"><a href="the-method.html#cb42-703" tabindex="-1"></a>  lambda_alpha <span class="ot">=</span> LCDmix<span class="sc">$</span>lambda_alpha</span>
<span id="cb42-704"><a href="the-method.html#cb42-704" tabindex="-1"></a>  lambda_theta <span class="ot">=</span> LCDmix<span class="sc">$</span>lambda_theta</span>
<span id="cb42-705"><a href="the-method.html#cb42-705" tabindex="-1"></a>  </span>
<span id="cb42-706"><a href="the-method.html#cb42-706" tabindex="-1"></a>  K <span class="ot">=</span> <span class="fu">length</span>(g)</span>
<span id="cb42-707"><a href="the-method.html#cb42-707" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">unlist</span>(biomass_new))</span>
<span id="cb42-708"><a href="the-method.html#cb42-708" tabindex="-1"></a>  P <span class="ot">=</span> <span class="fu">pi_k</span>(X_new, alpha) <span class="co"># TT by K matrix</span></span>
<span id="cb42-709"><a href="the-method.html#cb42-709" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">dim</span>(X_new)[<span class="dv">2</span>]</span>
<span id="cb42-710"><a href="the-method.html#cb42-710" tabindex="-1"></a>  TT <span class="ot">=</span> <span class="fu">dim</span>(X_new)[<span class="dv">1</span>]</span>
<span id="cb42-711"><a href="the-method.html#cb42-711" tabindex="-1"></a>  w_tt <span class="ot">=</span> <span class="fu">unlist</span>(biomass_new)</span>
<span id="cb42-712"><a href="the-method.html#cb42-712" tabindex="-1"></a>  loglike <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-713"><a href="the-method.html#cb42-713" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>TT){</span>
<span id="cb42-714"><a href="the-method.html#cb42-714" tabindex="-1"></a>    loglike_tk <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(Y_new[[t]]))</span>
<span id="cb42-715"><a href="the-method.html#cb42-715" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K){</span>
<span id="cb42-716"><a href="the-method.html#cb42-716" tabindex="-1"></a>      resi_tk <span class="ot">=</span> Y_new[[t]] <span class="sc">-</span> <span class="fu">c</span>(theta0[[k]] <span class="sc">+</span> <span class="fu">sum</span>(X_new[t,] <span class="sc">*</span> theta[[k]]))</span>
<span id="cb42-717"><a href="the-method.html#cb42-717" tabindex="-1"></a>      <span class="fu">suppressWarnings</span>({tmp <span class="ot">=</span> logcondens<span class="sc">::</span><span class="fu">evaluateLogConDens</span>(resi_tk, g[[k]])[,<span class="dv">3</span>] <span class="sc">*</span> P[t,k]})</span>
<span id="cb42-718"><a href="the-method.html#cb42-718" tabindex="-1"></a>      loglike_tk <span class="ot">=</span> loglike_tk <span class="sc">+</span> tmp</span>
<span id="cb42-719"><a href="the-method.html#cb42-719" tabindex="-1"></a>      }</span>
<span id="cb42-720"><a href="the-method.html#cb42-720" tabindex="-1"></a>    loglike <span class="ot">=</span> <span class="fu">c</span>(loglike, <span class="fu">log</span>(loglike_tk))</span>
<span id="cb42-721"><a href="the-method.html#cb42-721" tabindex="-1"></a>    }</span>
<span id="cb42-722"><a href="the-method.html#cb42-722" tabindex="-1"></a>  prop <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">is.infinite</span>(loglike))</span>
<span id="cb42-723"><a href="the-method.html#cb42-723" tabindex="-1"></a>  q <span class="ot">=</span> <span class="fu">weighted_quantile</span>(loglike, w_tt, trim_thr)</span>
<span id="cb42-724"><a href="the-method.html#cb42-724" tabindex="-1"></a>  trimmed <span class="ot">=</span> loglike[loglike <span class="sc">&gt;</span> q]</span>
<span id="cb42-725"><a href="the-method.html#cb42-725" tabindex="-1"></a>  w_trimmed <span class="ot">=</span> w_tt[loglike <span class="sc">&gt;</span> q]</span>
<span id="cb42-726"><a href="the-method.html#cb42-726" tabindex="-1"></a>  trimmed_logl <span class="ot">=</span> <span class="fu">sum</span>(trimmed <span class="sc">*</span> w_trimmed) <span class="sc">/</span> <span class="fu">sum</span>(w_trimmed) <span class="sc">-</span> lambda_alpha <span class="sc">*</span> <span class="fu">sum</span>(<span class="fu">abs</span>(alpha[,<span class="dv">2</span><span class="sc">:</span>(p<span class="sc">+</span><span class="dv">1</span>)])) <span class="sc">-</span> lambda_theta <span class="sc">*</span> <span class="fu">sum</span>(<span class="fu">abs</span>(<span class="fu">unlist</span>(theta)))</span>
<span id="cb42-727"><a href="the-method.html#cb42-727" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">loglike =</span> loglike,</span>
<span id="cb42-728"><a href="the-method.html#cb42-728" tabindex="-1"></a>              <span class="at">w_tt =</span> w_tt,</span>
<span id="cb42-729"><a href="the-method.html#cb42-729" tabindex="-1"></a>              <span class="at">prop =</span> prop,</span>
<span id="cb42-730"><a href="the-method.html#cb42-730" tabindex="-1"></a>              <span class="at">trimmed =</span> trimmed,</span>
<span id="cb42-731"><a href="the-method.html#cb42-731" tabindex="-1"></a>              <span class="at">w_trimmed =</span> w_trimmed,</span>
<span id="cb42-732"><a href="the-method.html#cb42-732" tabindex="-1"></a>              <span class="at">trimmed_logl =</span> trimmed_logl))</span>
<span id="cb42-733"><a href="the-method.html#cb42-733" tabindex="-1"></a>}</span>
<span id="cb42-734"><a href="the-method.html#cb42-734" tabindex="-1"></a>  </span>
<span id="cb42-735"><a href="the-method.html#cb42-735" tabindex="-1"></a></span>
<span id="cb42-736"><a href="the-method.html#cb42-736" tabindex="-1"></a></span>
<span id="cb42-737"><a href="the-method.html#cb42-737" tabindex="-1"></a>make_iimat <span class="ot">=</span> <span class="cf">function</span>(cv_gridsize, nfold, nrep, alpha_lambdas, theta_lambdas){</span>
<span id="cb42-738"><a href="the-method.html#cb42-738" tabindex="-1"></a>  iimat <span class="ot">=</span> <span class="fu">expand.grid</span>(<span class="dv">1</span><span class="sc">:</span>nfold,<span class="dv">1</span><span class="sc">:</span>nrep,<span class="dv">1</span><span class="sc">:</span>cv_gridsize,<span class="dv">1</span><span class="sc">:</span>cv_gridsize)</span>
<span id="cb42-739"><a href="the-method.html#cb42-739" tabindex="-1"></a>  iimat <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">ialpha =</span> iimat[,<span class="dv">4</span>], </span>
<span id="cb42-740"><a href="the-method.html#cb42-740" tabindex="-1"></a>                <span class="at">itheta =</span> iimat[,<span class="dv">3</span>], </span>
<span id="cb42-741"><a href="the-method.html#cb42-741" tabindex="-1"></a>                <span class="at">irep =</span> iimat[,<span class="dv">2</span>], </span>
<span id="cb42-742"><a href="the-method.html#cb42-742" tabindex="-1"></a>                <span class="at">ifold =</span> iimat[,<span class="dv">1</span>],</span>
<span id="cb42-743"><a href="the-method.html#cb42-743" tabindex="-1"></a>                <span class="at">lambda_alpha =</span> alpha_lambdas[iimat[,<span class="dv">4</span>]], </span>
<span id="cb42-744"><a href="the-method.html#cb42-744" tabindex="-1"></a>                <span class="at">lambda_theta =</span> theta_lambdas[iimat[,<span class="dv">3</span>]])</span>
<span id="cb42-745"><a href="the-method.html#cb42-745" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.matrix</span>(iimat))</span>
<span id="cb42-746"><a href="the-method.html#cb42-746" tabindex="-1"></a>}</span>
<span id="cb42-747"><a href="the-method.html#cb42-747" tabindex="-1"></a></span>
<span id="cb42-748"><a href="the-method.html#cb42-748" tabindex="-1"></a></span>
<span id="cb42-749"><a href="the-method.html#cb42-749" tabindex="-1"></a></span>
<span id="cb42-750"><a href="the-method.html#cb42-750" tabindex="-1"></a></span>
<span id="cb42-751"><a href="the-method.html#cb42-751" tabindex="-1"></a>CV_LCD_parallel <span class="ot">=</span> <span class="cf">function</span>(Y_bin, X, bin_mass, K, <span class="at">lambda_alpha_range =</span> <span class="fu">c</span>(<span class="fl">1e-8</span>, <span class="fl">1e-1</span>), <span class="at">lambda_theta_range =</span> <span class="fu">c</span>(<span class="fl">1e-8</span>, <span class="fl">1e-1</span>), <span class="at">cv_gridsize =</span> <span class="dv">5</span>, <span class="at">nrep_flowmix =</span> <span class="dv">1</span>, <span class="at">max_iter =</span> <span class="dv">30</span>, <span class="at">iter_eta =</span> <span class="fl">1e-3</span>, <span class="at">maxdev =</span> <span class="cn">NULL</span>, <span class="at">r_bar =</span> <span class="fl">1e-3</span>, <span class="at">nfold =</span> <span class="dv">5</span>, <span class="at">blocksize =</span> <span class="dv">5</span>, <span class="at">nrep =</span> <span class="dv">5</span>, <span class="at">trim_thr =</span> <span class="fl">0.05</span>, <span class="at">save_folder =</span> <span class="st">'./result'</span>){</span>
<span id="cb42-752"><a href="the-method.html#cb42-752" tabindex="-1"></a></span>
<span id="cb42-753"><a href="the-method.html#cb42-753" tabindex="-1"></a>  alpha_lambdas <span class="ot">=</span> <span class="fu">sort</span>(flowmix<span class="sc">::</span><span class="fu">logspace</span>(<span class="at">min =</span> lambda_alpha_range[<span class="dv">1</span>], <span class="at">max =</span> lambda_alpha_range[<span class="dv">2</span>], <span class="at">length =</span> cv_gridsize), <span class="at">decreasing =</span> F)</span>
<span id="cb42-754"><a href="the-method.html#cb42-754" tabindex="-1"></a>  theta_lambdas <span class="ot">=</span> <span class="fu">sort</span>(flowmix<span class="sc">::</span><span class="fu">logspace</span>(<span class="at">min =</span> lambda_theta_range[<span class="dv">1</span>], <span class="at">max =</span> lambda_theta_range[<span class="dv">2</span>], <span class="at">length =</span> cv_gridsize), <span class="at">decreasing =</span> F)</span>
<span id="cb42-755"><a href="the-method.html#cb42-755" tabindex="-1"></a>  <span class="fu">print</span>(alpha_lambdas)</span>
<span id="cb42-756"><a href="the-method.html#cb42-756" tabindex="-1"></a>  <span class="fu">print</span>(theta_lambdas)</span>
<span id="cb42-757"><a href="the-method.html#cb42-757" tabindex="-1"></a>  </span>
<span id="cb42-758"><a href="the-method.html#cb42-758" tabindex="-1"></a>  folds <span class="ot">=</span> flowmix<span class="sc">::</span><span class="fu">make_cv_folds</span>(<span class="at">ylist =</span> Y_bin, <span class="at">nfold =</span> nfold, <span class="at">blocksize =</span> blocksize)</span>
<span id="cb42-759"><a href="the-method.html#cb42-759" tabindex="-1"></a>  </span>
<span id="cb42-760"><a href="the-method.html#cb42-760" tabindex="-1"></a>  iimat <span class="ot">=</span> <span class="fu">make_iimat</span>(cv_gridsize, nfold, nrep, alpha_lambdas, theta_lambdas)</span>
<span id="cb42-761"><a href="the-method.html#cb42-761" tabindex="-1"></a>  <span class="fu">print</span>(iimat)</span>
<span id="cb42-762"><a href="the-method.html#cb42-762" tabindex="-1"></a></span>
<span id="cb42-763"><a href="the-method.html#cb42-763" tabindex="-1"></a>  cl <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">makeCluster</span>(parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">logical =</span> <span class="cn">FALSE</span>) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb42-764"><a href="the-method.html#cb42-764" tabindex="-1"></a>  parallel<span class="sc">::</span><span class="fu">clusterExport</span>(cl, <span class="fu">c</span>(<span class="st">"main"</span>, <span class="st">"binning"</span>, <span class="st">"initialization"</span>, <span class="st">"iteration"</span>, <span class="st">"calc_resi"</span>, <span class="st">"pi_k"</span>, <span class="st">"Mstep_alpha"</span>, <span class="st">"Mstep_theta_logcondens"</span>, <span class="st">"LP_logcondens"</span>, <span class="st">"Mstep_shift"</span>, <span class="st">"Mstep_g_logcondens"</span>, <span class="st">"calc_surr_logcondens"</span>, <span class="st">"modified_logcondens"</span>, <span class="st">"E_step_logcondens"</span>, <span class="st">"weighted_quantile"</span>, <span class="st">"eval_LCD"</span>, <span class="st">"Y_bin"</span>, <span class="st">"X"</span>, <span class="st">"bin_mass"</span>, <span class="st">"K"</span>, <span class="st">"nrep_flowmix"</span>, <span class="st">"max_iter"</span>, <span class="st">"iter_eta"</span>, <span class="st">"maxdev"</span>, <span class="st">"r_bar"</span>, <span class="st">"trim_thr"</span>, <span class="st">"iimat"</span>, <span class="st">"folds"</span>, <span class="st">"save_folder"</span>), <span class="at">envir =</span> <span class="fu">environment</span>())</span>
<span id="cb42-765"><a href="the-method.html#cb42-765" tabindex="-1"></a>  logs <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">parLapply</span>(cl, <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(iimat), <span class="cf">function</span>(ii){</span>
<span id="cb42-766"><a href="the-method.html#cb42-766" tabindex="-1"></a>    ialpha <span class="ot">=</span> iimat[ii, <span class="dv">1</span>]</span>
<span id="cb42-767"><a href="the-method.html#cb42-767" tabindex="-1"></a>    itheta <span class="ot">=</span> iimat[ii, <span class="dv">2</span>]</span>
<span id="cb42-768"><a href="the-method.html#cb42-768" tabindex="-1"></a>    irep <span class="ot">=</span> iimat[ii, <span class="dv">3</span>]</span>
<span id="cb42-769"><a href="the-method.html#cb42-769" tabindex="-1"></a>    ifold <span class="ot">=</span> iimat[ii, <span class="dv">4</span>]</span>
<span id="cb42-770"><a href="the-method.html#cb42-770" tabindex="-1"></a>    lambda_alpha <span class="ot">=</span> iimat[ii, <span class="dv">5</span>]</span>
<span id="cb42-771"><a href="the-method.html#cb42-771" tabindex="-1"></a>    lambda_theta <span class="ot">=</span> iimat[ii, <span class="dv">6</span>]</span>
<span id="cb42-772"><a href="the-method.html#cb42-772" tabindex="-1"></a>    </span>
<span id="cb42-773"><a href="the-method.html#cb42-773" tabindex="-1"></a>    log_msg <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">"lambda_alpha = "</span>, lambda_alpha, <span class="st">" lambda_theta = "</span>, lambda_theta, <span class="st">" with "</span>, irep, <span class="st">"th rep on "</span>, ifold, <span class="st">"th fold started</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-774"><a href="the-method.html#cb42-774" tabindex="-1"></a></span>
<span id="cb42-775"><a href="the-method.html#cb42-775" tabindex="-1"></a>    Y_tr <span class="ot">=</span> Y_bin[<span class="sc">-</span>folds[[ifold]]]</span>
<span id="cb42-776"><a href="the-method.html#cb42-776" tabindex="-1"></a>    bin_mass_tr <span class="ot">=</span> bin_mass[<span class="sc">-</span>folds[[ifold]]]</span>
<span id="cb42-777"><a href="the-method.html#cb42-777" tabindex="-1"></a>    X_tr<span class="ot">=</span> X[<span class="sc">-</span>folds[[ifold]], ]</span>
<span id="cb42-778"><a href="the-method.html#cb42-778" tabindex="-1"></a>    <span class="fu">set.seed</span>(irep)</span>
<span id="cb42-779"><a href="the-method.html#cb42-779" tabindex="-1"></a>    out_log <span class="ot">=</span> <span class="fu">capture.output</span>({res_ii <span class="ot">=</span> <span class="fu">tryCatch</span>({</span>
<span id="cb42-780"><a href="the-method.html#cb42-780" tabindex="-1"></a>      <span class="fu">main</span>(Y_tr, X_tr, bin_mass_tr, <span class="at">binned =</span> T, <span class="at">B =</span> <span class="dv">0</span>, K, lambda_alpha, lambda_theta, nrep_flowmix, max_iter, iter_eta, maxdev, r_bar)},</span>
<span id="cb42-781"><a href="the-method.html#cb42-781" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb42-782"><a href="the-method.html#cb42-782" tabindex="-1"></a>        <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">"Error for lambda_alpha = "</span>, lambda_alpha, <span class="st">" lambda_theta = "</span>, lambda_theta, <span class="st">" with "</span>, irep, <span class="st">"th rep on "</span>, ifold, <span class="st">"th fold."</span>))</span>
<span id="cb42-783"><a href="the-method.html#cb42-783" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NA</span>)})})</span>
<span id="cb42-784"><a href="the-method.html#cb42-784" tabindex="-1"></a>    log_msg <span class="ot">=</span> <span class="fu">paste0</span>(log_msg, <span class="fu">paste0</span>(out_log, <span class="at">collapse =</span> <span class="st">""</span>))</span>
<span id="cb42-785"><a href="the-method.html#cb42-785" tabindex="-1"></a>    </span>
<span id="cb42-786"><a href="the-method.html#cb42-786" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.list</span>(res_ii)){</span>
<span id="cb42-787"><a href="the-method.html#cb42-787" tabindex="-1"></a>      Y_test <span class="ot">=</span> Y_bin[folds[[ifold]]]</span>
<span id="cb42-788"><a href="the-method.html#cb42-788" tabindex="-1"></a>      bin_mass_test <span class="ot">=</span> bin_mass[folds[[ifold]]]</span>
<span id="cb42-789"><a href="the-method.html#cb42-789" tabindex="-1"></a>      X_test<span class="ot">=</span> X[folds[[ifold]], ]</span>
<span id="cb42-790"><a href="the-method.html#cb42-790" tabindex="-1"></a>      eval_ii <span class="ot">=</span> <span class="fu">eval_LCD</span>(res_ii<span class="sc">$</span>iter, Y_test, X_test, bin_mass_test, <span class="at">trim_thr =</span> trim_thr)</span>
<span id="cb42-791"><a href="the-method.html#cb42-791" tabindex="-1"></a>      prop_CV <span class="ot">=</span> eval_ii<span class="sc">$</span>prop</span>
<span id="cb42-792"><a href="the-method.html#cb42-792" tabindex="-1"></a>      trimmed_CV <span class="ot">=</span> eval_ii<span class="sc">$</span>trimmed_logl</span>
<span id="cb42-793"><a href="the-method.html#cb42-793" tabindex="-1"></a>      log_msg <span class="ot">=</span> <span class="fu">paste0</span>(log_msg, <span class="st">"Saved results for lambda_alpha = "</span>, lambda_alpha, <span class="st">" lambda_theta = "</span>, lambda_theta, <span class="st">" with "</span>, irep, <span class="st">"th rep on "</span>, ifold, <span class="st">"th fold.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-794"><a href="the-method.html#cb42-794" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb42-795"><a href="the-method.html#cb42-795" tabindex="-1"></a>      prop_CV <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb42-796"><a href="the-method.html#cb42-796" tabindex="-1"></a>      trimmed_CV <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb42-797"><a href="the-method.html#cb42-797" tabindex="-1"></a>      log_msg <span class="ot">=</span> <span class="fu">paste0</span>(log_msg, <span class="st">"Error for lambda_alpha = "</span>, lambda_alpha, <span class="st">" lambda_theta = "</span>, lambda_theta, <span class="st">" with "</span>, irep, <span class="st">"th rep on "</span>, ifold, <span class="st">"th fold!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-798"><a href="the-method.html#cb42-798" tabindex="-1"></a>    }</span>
<span id="cb42-799"><a href="the-method.html#cb42-799" tabindex="-1"></a>    save_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(save_folder, <span class="fu">paste0</span>(<span class="st">'/'</span>, ialpha, <span class="st">'-'</span>, itheta, <span class="st">'-'</span>, irep, <span class="st">'-'</span>, ifold, <span class="st">'.Rdata'</span>))</span>
<span id="cb42-800"><a href="the-method.html#cb42-800" tabindex="-1"></a>    <span class="fu">save</span>(prop_CV, trimmed_CV, <span class="at">file =</span> save_path)</span>
<span id="cb42-801"><a href="the-method.html#cb42-801" tabindex="-1"></a>    <span class="fu">return</span>(log_msg)</span>
<span id="cb42-802"><a href="the-method.html#cb42-802" tabindex="-1"></a>        })</span>
<span id="cb42-803"><a href="the-method.html#cb42-803" tabindex="-1"></a>  parallel<span class="sc">::</span><span class="fu">stopCluster</span>(cl)</span>
<span id="cb42-804"><a href="the-method.html#cb42-804" tabindex="-1"></a>    num_NA <span class="ot">=</span> <span class="fu">sapply</span>(logs, <span class="cf">function</span>(x){</span>
<span id="cb42-805"><a href="the-method.html#cb42-805" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">substring</span>(x, <span class="fu">nchar</span>(x)<span class="sc">-</span><span class="dv">1</span>, <span class="fu">nchar</span>(x)<span class="sc">-</span><span class="dv">1</span>) <span class="sc">==</span> <span class="st">'!'</span>) {</span>
<span id="cb42-806"><a href="the-method.html#cb42-806" tabindex="-1"></a>      <span class="fu">return</span>(<span class="dv">1</span>)</span>
<span id="cb42-807"><a href="the-method.html#cb42-807" tabindex="-1"></a>    } <span class="cf">else</span> {<span class="fu">return</span>(<span class="dv">0</span>)}</span>
<span id="cb42-808"><a href="the-method.html#cb42-808" tabindex="-1"></a>  })</span>
<span id="cb42-809"><a href="the-method.html#cb42-809" tabindex="-1"></a>  logs <span class="ot">=</span> <span class="fu">append</span>(logs, </span>
<span id="cb42-810"><a href="the-method.html#cb42-810" tabindex="-1"></a>                   <span class="fu">paste0</span>(<span class="st">"There are "</span>, <span class="fu">sum</span>(num_NA), <span class="st">"NA results out of "</span>, </span>
<span id="cb42-811"><a href="the-method.html#cb42-811" tabindex="-1"></a>                          <span class="fu">length</span>(num_NA), <span class="st">"results ("</span>, <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span><span class="fu">mean</span>(num_NA), <span class="dv">2</span>), <span class="st">"%)."</span> ))</span>
<span id="cb42-812"><a href="the-method.html#cb42-812" tabindex="-1"></a>  </span>
<span id="cb42-813"><a href="the-method.html#cb42-813" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">logs =</span> logs,</span>
<span id="cb42-814"><a href="the-method.html#cb42-814" tabindex="-1"></a>              <span class="at">iimat =</span> iimat))</span>
<span id="cb42-815"><a href="the-method.html#cb42-815" tabindex="-1"></a>}</span>
<span id="cb42-816"><a href="the-method.html#cb42-816" tabindex="-1"></a></span>
<span id="cb42-817"><a href="the-method.html#cb42-817" tabindex="-1"></a></span>
<span id="cb42-818"><a href="the-method.html#cb42-818" tabindex="-1"></a></span>
<span id="cb42-819"><a href="the-method.html#cb42-819" tabindex="-1"></a></span>
<span id="cb42-820"><a href="the-method.html#cb42-820" tabindex="-1"></a></span>
<span id="cb42-821"><a href="the-method.html#cb42-821" tabindex="-1"></a>CV_summary <span class="ot">=</span> <span class="cf">function</span>(iimat, <span class="at">save_folder =</span> <span class="st">'./result'</span>){</span>
<span id="cb42-822"><a href="the-method.html#cb42-822" tabindex="-1"></a>  n <span class="ot">=</span> <span class="fu">nrow</span>(iimat)</span>
<span id="cb42-823"><a href="the-method.html#cb42-823" tabindex="-1"></a>  CVmat <span class="ot">=</span> <span class="fu">cbind</span>(iimat, <span class="fu">rep</span>(<span class="cn">NA</span>, n), <span class="fu">rep</span>(<span class="cn">NA</span>, n))</span>
<span id="cb42-824"><a href="the-method.html#cb42-824" tabindex="-1"></a>  </span>
<span id="cb42-825"><a href="the-method.html#cb42-825" tabindex="-1"></a>  <span class="cf">for</span> (ii <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(iimat)){</span>
<span id="cb42-826"><a href="the-method.html#cb42-826" tabindex="-1"></a>    ialpha <span class="ot">=</span> iimat[ii, <span class="dv">1</span>]</span>
<span id="cb42-827"><a href="the-method.html#cb42-827" tabindex="-1"></a>    itheta <span class="ot">=</span> iimat[ii, <span class="dv">2</span>]</span>
<span id="cb42-828"><a href="the-method.html#cb42-828" tabindex="-1"></a>    irep <span class="ot">=</span> iimat[ii, <span class="dv">3</span>]</span>
<span id="cb42-829"><a href="the-method.html#cb42-829" tabindex="-1"></a>    ifold <span class="ot">=</span> iimat[ii, <span class="dv">4</span>]</span>
<span id="cb42-830"><a href="the-method.html#cb42-830" tabindex="-1"></a>    lambda_alpha <span class="ot">=</span> iimat[ii, <span class="dv">5</span>]</span>
<span id="cb42-831"><a href="the-method.html#cb42-831" tabindex="-1"></a>    lambda_theta <span class="ot">=</span> iimat[ii, <span class="dv">6</span>]</span>
<span id="cb42-832"><a href="the-method.html#cb42-832" tabindex="-1"></a>    </span>
<span id="cb42-833"><a href="the-method.html#cb42-833" tabindex="-1"></a>    file_name <span class="ot">=</span> <span class="fu">paste0</span>(save_folder,  <span class="fu">paste0</span>(<span class="st">'/'</span>, ialpha, <span class="st">'-'</span>, itheta, <span class="st">'-'</span>, irep, <span class="st">'-'</span>, ifold, <span class="st">'.Rdata'</span>))</span>
<span id="cb42-834"><a href="the-method.html#cb42-834" tabindex="-1"></a>    <span class="fu">load</span>(file_name)</span>
<span id="cb42-835"><a href="the-method.html#cb42-835" tabindex="-1"></a>    CVmat[ii, <span class="dv">7</span>] <span class="ot">=</span> prop_CV</span>
<span id="cb42-836"><a href="the-method.html#cb42-836" tabindex="-1"></a>    CVmat[ii, <span class="dv">8</span>] <span class="ot">=</span> trimmed_CV</span>
<span id="cb42-837"><a href="the-method.html#cb42-837" tabindex="-1"></a>  }</span>
<span id="cb42-838"><a href="the-method.html#cb42-838" tabindex="-1"></a>  <span class="fu">colnames</span>(CVmat)[<span class="dv">7</span><span class="sc">:</span><span class="dv">8</span>] <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'prop_CV'</span>, <span class="st">'trimmed_CV'</span>)</span>
<span id="cb42-839"><a href="the-method.html#cb42-839" tabindex="-1"></a>  max_NA_prop <span class="ot">=</span> <span class="fu">max</span>(CVmat[,<span class="dv">7</span>], <span class="at">na.rm =</span> T)</span>
<span id="cb42-840"><a href="the-method.html#cb42-840" tabindex="-1"></a>  </span>
<span id="cb42-841"><a href="the-method.html#cb42-841" tabindex="-1"></a>  reduced_mat <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-842"><a href="the-method.html#cb42-842" tabindex="-1"></a>  nrep <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">table</span>(iimat[,<span class="st">'irep'</span>]))</span>
<span id="cb42-843"><a href="the-method.html#cb42-843" tabindex="-1"></a>  nfold <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">table</span>(iimat[,<span class="st">'ifold'</span>]))</span>
<span id="cb42-844"><a href="the-method.html#cb42-844" tabindex="-1"></a>  nchunk <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">table</span>(iimat[, <span class="st">'ialpha'</span>]))<span class="sc">**</span><span class="dv">2</span></span>
<span id="cb42-845"><a href="the-method.html#cb42-845" tabindex="-1"></a>  </span>
<span id="cb42-846"><a href="the-method.html#cb42-846" tabindex="-1"></a>  size <span class="ot">=</span> nrep <span class="sc">*</span> nfold</span>
<span id="cb42-847"><a href="the-method.html#cb42-847" tabindex="-1"></a>  cnt_NA <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb42-848"><a href="the-method.html#cb42-848" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nchunk){</span>
<span id="cb42-849"><a href="the-method.html#cb42-849" tabindex="-1"></a>    tmp <span class="ot">=</span> CVmat[((i<span class="dv">-1</span>)<span class="sc">*</span>size<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(i<span class="sc">*</span>size), ]</span>
<span id="cb42-850"><a href="the-method.html#cb42-850" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">table</span>(tmp[,<span class="dv">5</span>])) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">|</span> <span class="fu">length</span>(<span class="fu">table</span>(tmp[,<span class="dv">6</span>])) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb42-851"><a href="the-method.html#cb42-851" tabindex="-1"></a>      <span class="fu">print</span>(<span class="st">'error'</span>)</span>
<span id="cb42-852"><a href="the-method.html#cb42-852" tabindex="-1"></a>    }</span>
<span id="cb42-853"><a href="the-method.html#cb42-853" tabindex="-1"></a>    tmp_CV <span class="ot">=</span> <span class="fu">max</span>(<span class="fu">tapply</span>(tmp[,<span class="st">'trimmed_CV'</span>], <span class="fu">factor</span>(tmp[,<span class="st">'irep'</span>]), mean, <span class="at">na.rm =</span> T))</span>
<span id="cb42-854"><a href="the-method.html#cb42-854" tabindex="-1"></a>    reduced_mat <span class="ot">=</span> <span class="fu">rbind</span>(reduced_mat, <span class="fu">cbind</span>(tmp[<span class="dv">1</span>,<span class="dv">5</span>], tmp[<span class="dv">1</span>,<span class="dv">6</span>], tmp_CV))</span>
<span id="cb42-855"><a href="the-method.html#cb42-855" tabindex="-1"></a>  }</span>
<span id="cb42-856"><a href="the-method.html#cb42-856" tabindex="-1"></a>  <span class="fu">rownames</span>(reduced_mat) <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb42-857"><a href="the-method.html#cb42-857" tabindex="-1"></a>  <span class="fu">colnames</span>(reduced_mat)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"lambda_alpha"</span>, <span class="st">"lambda_theta"</span>)</span>
<span id="cb42-858"><a href="the-method.html#cb42-858" tabindex="-1"></a>  opt_lambdas <span class="ot">=</span> reduced_mat[<span class="fu">which.max</span>(reduced_mat[,<span class="dv">3</span>]), <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb42-859"><a href="the-method.html#cb42-859" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">CVmat =</span> CVmat,</span>
<span id="cb42-860"><a href="the-method.html#cb42-860" tabindex="-1"></a>              <span class="at">reduced_mat =</span> reduced_mat,</span>
<span id="cb42-861"><a href="the-method.html#cb42-861" tabindex="-1"></a>              <span class="at">opt_lambdas =</span> opt_lambdas,</span>
<span id="cb42-862"><a href="the-method.html#cb42-862" tabindex="-1"></a>              <span class="at">max_NA_prop =</span> max_NA_prop))</span>
<span id="cb42-863"><a href="the-method.html#cb42-863" tabindex="-1"></a>}</span>
<span id="cb42-864"><a href="the-method.html#cb42-864" tabindex="-1"></a></span>
<span id="cb42-865"><a href="the-method.html#cb42-865" tabindex="-1"></a></span>
<span id="cb42-866"><a href="the-method.html#cb42-866" tabindex="-1"></a>refit <span class="ot">=</span> <span class="cf">function</span>(Y_bin, X, bin_mass, K, <span class="at">opt_lambdas =</span> <span class="fu">c</span>(<span class="fl">1e-3</span>, <span class="fl">1e-3</span>), <span class="at">nrep_flowmix =</span> <span class="dv">1</span>, <span class="at">max_iter =</span> <span class="dv">30</span>, <span class="at">iter_eta =</span> <span class="fl">1e-3</span>, <span class="at">maxdev =</span> <span class="cn">NULL</span>, <span class="at">r_bar =</span> <span class="fl">1e-3</span>, <span class="at">blocksize =</span> <span class="dv">5</span>, <span class="at">nrep =</span> <span class="dv">5</span>, <span class="at">trim_thr =</span> <span class="fl">0.05</span>, <span class="at">save_folder =</span> <span class="st">'./result'</span>){</span>
<span id="cb42-867"><a href="the-method.html#cb42-867" tabindex="-1"></a>  </span>
<span id="cb42-868"><a href="the-method.html#cb42-868" tabindex="-1"></a>  lambda_alpha <span class="ot">=</span> opt_lambdas[<span class="dv">1</span>]</span>
<span id="cb42-869"><a href="the-method.html#cb42-869" tabindex="-1"></a>  lambda_theta <span class="ot">=</span> opt_lambdas[<span class="dv">2</span>]</span>
<span id="cb42-870"><a href="the-method.html#cb42-870" tabindex="-1"></a></span>
<span id="cb42-871"><a href="the-method.html#cb42-871" tabindex="-1"></a>  cl <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">makeCluster</span>(parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">logical =</span> <span class="cn">FALSE</span>) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb42-872"><a href="the-method.html#cb42-872" tabindex="-1"></a>  parallel<span class="sc">::</span><span class="fu">clusterExport</span>(cl, <span class="fu">c</span>(<span class="st">"main"</span>, <span class="st">"binning"</span>, <span class="st">"initialization"</span>, <span class="st">"iteration"</span>, <span class="st">"calc_resi"</span>, <span class="st">"pi_k"</span>, <span class="st">"Mstep_alpha"</span>, <span class="st">"Mstep_theta_logcondens"</span>, <span class="st">"LP_logcondens"</span>, <span class="st">"Mstep_shift"</span>, <span class="st">"Mstep_g_logcondens"</span>, <span class="st">"calc_surr_logcondens"</span>, <span class="st">"modified_logcondens"</span>, <span class="st">"E_step_logcondens"</span>, <span class="st">"weighted_quantile"</span>, <span class="st">"eval_LCD"</span>, <span class="st">"Y_bin"</span>, <span class="st">"X"</span>, <span class="st">"bin_mass"</span>, <span class="st">"K"</span>, <span class="st">"nrep_flowmix"</span>, <span class="st">"max_iter"</span>, <span class="st">"iter_eta"</span>, <span class="st">"maxdev"</span>, <span class="st">"r_bar"</span>, <span class="st">"trim_thr"</span>, <span class="st">"save_folder"</span>), <span class="at">envir =</span> <span class="fu">environment</span>())</span>
<span id="cb42-873"><a href="the-method.html#cb42-873" tabindex="-1"></a>  logs <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">parLapply</span>(cl, <span class="dv">1</span><span class="sc">:</span>nrep, <span class="cf">function</span>(ii){</span>
<span id="cb42-874"><a href="the-method.html#cb42-874" tabindex="-1"></a>    log_msg <span class="ot">=</span> <span class="fu">paste</span>(ii, <span class="st">"th refit started</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-875"><a href="the-method.html#cb42-875" tabindex="-1"></a>    <span class="fu">set.seed</span>(ii)</span>
<span id="cb42-876"><a href="the-method.html#cb42-876" tabindex="-1"></a>    out_log <span class="ot">=</span> <span class="fu">capture.output</span>({res_ii <span class="ot">=</span> <span class="fu">tryCatch</span>({</span>
<span id="cb42-877"><a href="the-method.html#cb42-877" tabindex="-1"></a>      <span class="fu">main</span>(Y_bin, X, bin_mass, <span class="at">binned =</span> T, <span class="at">B =</span> <span class="dv">0</span>, K, lambda_alpha, lambda_theta, nrep_flowmix, max_iter, iter_eta, maxdev, r_bar)},</span>
<span id="cb42-878"><a href="the-method.html#cb42-878" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb42-879"><a href="the-method.html#cb42-879" tabindex="-1"></a>        <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">"Error for "</span>, ii, <span class="st">"th rep."</span>))</span>
<span id="cb42-880"><a href="the-method.html#cb42-880" tabindex="-1"></a>        <span class="fu">return</span>(<span class="cn">NA</span>)})})</span>
<span id="cb42-881"><a href="the-method.html#cb42-881" tabindex="-1"></a>    log_msg <span class="ot">=</span> <span class="fu">paste0</span>(log_msg, <span class="fu">paste0</span>(out_log, <span class="at">collapse =</span> <span class="st">""</span>))</span>
<span id="cb42-882"><a href="the-method.html#cb42-882" tabindex="-1"></a>    </span>
<span id="cb42-883"><a href="the-method.html#cb42-883" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.list</span>(res_ii)){</span>
<span id="cb42-884"><a href="the-method.html#cb42-884" tabindex="-1"></a>      <span class="co">#eval_ii = eval_LCD(res_ii$iter, Y_bin, X, bin_mass, trim_thr = trim_thr)</span></span>
<span id="cb42-885"><a href="the-method.html#cb42-885" tabindex="-1"></a>      refit_Q <span class="ot">=</span> res_ii<span class="sc">$</span>iter<span class="sc">$</span>Q[<span class="fu">length</span>(res_ii<span class="sc">$</span>iter<span class="sc">$</span>Q)]</span>
<span id="cb42-886"><a href="the-method.html#cb42-886" tabindex="-1"></a>      log_msg <span class="ot">=</span> <span class="fu">paste0</span>(log_msg, <span class="st">"Saved results for "</span>, ii, <span class="st">"th rep.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-887"><a href="the-method.html#cb42-887" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb42-888"><a href="the-method.html#cb42-888" tabindex="-1"></a>      refit_Q <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb42-889"><a href="the-method.html#cb42-889" tabindex="-1"></a>      res_ii <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb42-890"><a href="the-method.html#cb42-890" tabindex="-1"></a>      log_msg <span class="ot">=</span> <span class="fu">paste0</span>(log_msg, <span class="st">"Error for "</span>, ii, <span class="st">"th rep on!</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-891"><a href="the-method.html#cb42-891" tabindex="-1"></a>    }</span>
<span id="cb42-892"><a href="the-method.html#cb42-892" tabindex="-1"></a>    save_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(save_folder, <span class="fu">paste0</span>(<span class="st">'/refit'</span>, ii,<span class="st">'.Rdata'</span>))</span>
<span id="cb42-893"><a href="the-method.html#cb42-893" tabindex="-1"></a>    <span class="fu">save</span>(refit_Q, res_ii, <span class="at">file =</span> save_path)</span>
<span id="cb42-894"><a href="the-method.html#cb42-894" tabindex="-1"></a>    <span class="fu">return</span>(log_msg)</span>
<span id="cb42-895"><a href="the-method.html#cb42-895" tabindex="-1"></a>        })</span>
<span id="cb42-896"><a href="the-method.html#cb42-896" tabindex="-1"></a>  parallel<span class="sc">::</span><span class="fu">stopCluster</span>(cl)</span>
<span id="cb42-897"><a href="the-method.html#cb42-897" tabindex="-1"></a>    </span>
<span id="cb42-898"><a href="the-method.html#cb42-898" tabindex="-1"></a>  refit_QQ <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">0</span>, nrep)</span>
<span id="cb42-899"><a href="the-method.html#cb42-899" tabindex="-1"></a>  refit_res <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb42-900"><a href="the-method.html#cb42-900" tabindex="-1"></a>  <span class="cf">for</span> (ii <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nrep){</span>
<span id="cb42-901"><a href="the-method.html#cb42-901" tabindex="-1"></a>    file_name <span class="ot">=</span> <span class="fu">paste0</span>(save_folder, <span class="fu">paste0</span>(<span class="st">'/refit'</span>, ii,<span class="st">'.Rdata'</span>))</span>
<span id="cb42-902"><a href="the-method.html#cb42-902" tabindex="-1"></a>    <span class="fu">load</span>(file_name)</span>
<span id="cb42-903"><a href="the-method.html#cb42-903" tabindex="-1"></a>    refit_QQ[ii] <span class="ot">=</span> refit_Q</span>
<span id="cb42-904"><a href="the-method.html#cb42-904" tabindex="-1"></a>    refit_res[[ii]] <span class="ot">=</span> res_ii</span>
<span id="cb42-905"><a href="the-method.html#cb42-905" tabindex="-1"></a>  }</span>
<span id="cb42-906"><a href="the-method.html#cb42-906" tabindex="-1"></a>  logs <span class="ot">=</span> <span class="fu">append</span>(logs, </span>
<span id="cb42-907"><a href="the-method.html#cb42-907" tabindex="-1"></a>                   <span class="fu">paste0</span>(<span class="st">"There are "</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(refit_Q)), <span class="st">"NA results"</span> ))</span>
<span id="cb42-908"><a href="the-method.html#cb42-908" tabindex="-1"></a>  </span>
<span id="cb42-909"><a href="the-method.html#cb42-909" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">logs =</span> logs,</span>
<span id="cb42-910"><a href="the-method.html#cb42-910" tabindex="-1"></a>              <span class="at">refit_QQ =</span> refit_QQ,</span>
<span id="cb42-911"><a href="the-method.html#cb42-911" tabindex="-1"></a>              <span class="at">refit_res =</span> refit_res[[<span class="fu">which.max</span>(refit_QQ)]]))</span>
<span id="cb42-912"><a href="the-method.html#cb42-912" tabindex="-1"></a>}</span>
<span id="cb42-913"><a href="the-method.html#cb42-913" tabindex="-1"></a></span>
<span id="cb42-914"><a href="the-method.html#cb42-914" tabindex="-1"></a></span>
<span id="cb42-915"><a href="the-method.html#cb42-915" tabindex="-1"></a><span id="generate_skewed_data">generate_skewed_data</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">seed=</span><span class="cn">NULL</span>, </span>
<span id="cb42-916"><a href="the-method.html#cb42-916" tabindex="-1"></a>                                <span class="at">nt =</span> <span class="dv">200</span>,</span>
<span id="cb42-917"><a href="the-method.html#cb42-917" tabindex="-1"></a>                                <span class="at">beta_par =</span> <span class="fl">0.5</span>,</span>
<span id="cb42-918"><a href="the-method.html#cb42-918" tabindex="-1"></a>                                <span class="at">p =</span> <span class="dv">3</span>, <span class="do">## Number of total covariates</span></span>
<span id="cb42-919"><a href="the-method.html#cb42-919" tabindex="-1"></a>                                <span class="at">dat.gridsize =</span> <span class="dv">30</span>,</span>
<span id="cb42-920"><a href="the-method.html#cb42-920" tabindex="-1"></a>                                <span class="at">skew_alpha =</span> <span class="dv">10</span>,</span>
<span id="cb42-921"><a href="the-method.html#cb42-921" tabindex="-1"></a>                                <span class="at">gap =</span> <span class="dv">3</span>,</span>
<span id="cb42-922"><a href="the-method.html#cb42-922" tabindex="-1"></a>                                <span class="at">TT =</span> <span class="dv">100</span>){</span>
<span id="cb42-923"><a href="the-method.html#cb42-923" tabindex="-1"></a></span>
<span id="cb42-924"><a href="the-method.html#cb42-924" tabindex="-1"></a>  <span class="do">## Setup and basic checks</span></span>
<span id="cb42-925"><a href="the-method.html#cb42-925" tabindex="-1"></a>  assertthat<span class="sc">::</span><span class="fu">assert_that</span>(nt <span class="sc">%%</span> <span class="dv">5</span> <span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb42-926"><a href="the-method.html#cb42-926" tabindex="-1"></a>  ntlist <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="fl">0.8</span> <span class="sc">*</span> nt, TT<span class="sc">/</span><span class="dv">2</span>), <span class="fu">rep</span>(nt, TT<span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb42-927"><a href="the-method.html#cb42-927" tabindex="-1"></a>  numclust <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb42-928"><a href="the-method.html#cb42-928" tabindex="-1"></a>  <span class="fu">stopifnot</span>(p <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb42-929"><a href="the-method.html#cb42-929" tabindex="-1"></a>  </span>
<span id="cb42-930"><a href="the-method.html#cb42-930" tabindex="-1"></a>  <span class="do">## Generate covariate</span></span>
<span id="cb42-931"><a href="the-method.html#cb42-931" tabindex="-1"></a>  par <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb42-932"><a href="the-method.html#cb42-932" tabindex="-1"></a>  <span class="fl">1807.884</span>, <span class="fl">168.2681</span>, <span class="fl">0.0006315789</span>, <span class="sc">-</span><span class="fl">0.0139</span>, <span class="sc">-</span><span class="fl">0.01336364</span>, <span class="sc">-</span><span class="fl">0.014</span>, <span class="sc">-</span><span class="fl">0.013125</span>, <span class="sc">-</span><span class="fl">0.014</span>,</span>
<span id="cb42-933"><a href="the-method.html#cb42-933" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.0128</span>, <span class="fl">0.218</span>, <span class="fl">0.3867778</span>, <span class="fl">23.893</span>, <span class="fl">3320.086</span>, <span class="fl">3278.974</span>, <span class="fl">3584.604</span>, <span class="fl">3769.884</span>,</span>
<span id="cb42-934"><a href="the-method.html#cb42-934" tabindex="-1"></a>  <span class="fl">3124.176</span>, <span class="fl">3210.607</span>, <span class="fl">2222.561</span>, <span class="fl">2619.597</span>, <span class="fl">1457.061</span>, <span class="fl">87.64753</span>, <span class="fl">0.03627778</span>, <span class="sc">-</span><span class="fl">0.009875</span>,</span>
<span id="cb42-935"><a href="the-method.html#cb42-935" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.002125</span>, <span class="fl">0.372</span>, <span class="fl">0.526</span>, <span class="fl">32.36786</span>, <span class="fl">317.9361</span>, <span class="fl">784.968</span>, <span class="fl">1448.081</span>, <span class="fl">1624.513</span>,</span>
<span id="cb42-936"><a href="the-method.html#cb42-936" tabindex="-1"></a>  <span class="fl">2499.522</span>, <span class="fl">2059.033</span>, <span class="fl">2005.622</span>, <span class="fl">1719.437</span>, <span class="fl">1811.938</span>, <span class="fl">2868.744</span>, <span class="fl">1851.804</span>, <span class="fl">1101.775</span>,</span>
<span id="cb42-937"><a href="the-method.html#cb42-937" tabindex="-1"></a>  <span class="fl">646.0992</span>, <span class="fl">27.92433</span>, <span class="fl">0.6711875</span>, <span class="sc">-</span><span class="fl">0.013</span>, <span class="sc">-</span><span class="fl">0.01711765</span>, <span class="sc">-</span><span class="fl">0.014125</span>, <span class="sc">-</span><span class="fl">0.0134</span>, <span class="sc">-</span><span class="fl">0.01175</span>,</span>
<span id="cb42-938"><a href="the-method.html#cb42-938" tabindex="-1"></a>  <span class="fl">0.01726316</span>, <span class="fl">0.3675625</span>, <span class="fl">0.4200588</span>, <span class="fl">35.718</span>, <span class="fl">272.8423</span>, <span class="fl">655.5318</span>, <span class="fl">872.1162</span>, <span class="fl">1685.27</span>,</span>
<span id="cb42-939"><a href="the-method.html#cb42-939" tabindex="-1"></a>  <span class="fl">2138.353</span>, <span class="fl">2799.593</span>, <span class="fl">3552.781</span>, <span class="fl">3003.885</span>, <span class="fl">2739.476</span>, <span class="fl">2525.467</span>, <span class="fl">1645.232</span>, <span class="fl">1257.148</span>,</span>
<span id="cb42-940"><a href="the-method.html#cb42-940" tabindex="-1"></a>  <span class="fl">322.8541</span>, <span class="fl">54.98407</span>, <span class="fl">1.811</span>, <span class="sc">-</span><span class="fl">0.006733333</span>, <span class="sc">-</span><span class="fl">0.009428571</span>, <span class="sc">-</span><span class="fl">0.0069</span>, <span class="sc">-</span><span class="fl">0.005692308</span>, <span class="sc">-</span><span class="fl">0.0107</span>,</span>
<span id="cb42-941"><a href="the-method.html#cb42-941" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.009923077</span>, <span class="fl">0.2817778</span>, <span class="fl">1.216714</span>, <span class="fl">76.83171</span>, <span class="fl">211.934</span>, <span class="fl">373.5088</span>, <span class="fl">518.5455</span>, <span class="fl">792.2462</span>,</span>
<span id="cb42-942"><a href="the-method.html#cb42-942" tabindex="-1"></a>  <span class="fl">931.5338</span>, <span class="fl">1421.289</span>, <span class="fl">913.1166</span>, <span class="fl">841.0782</span>, <span class="fl">922.5017</span>, <span class="fl">788.3413</span>, <span class="fl">685.737</span>, <span class="fl">291.6708</span>,</span>
<span id="cb42-943"><a href="the-method.html#cb42-943" tabindex="-1"></a>  <span class="fl">122.616</span>, <span class="fl">34.555</span>, <span class="fl">0.422</span>, <span class="sc">-</span><span class="fl">0.009333333</span>, <span class="sc">-</span><span class="fl">0.0095</span>, <span class="sc">-</span><span class="fl">0.01375</span>, <span class="sc">-</span><span class="fl">0.01181818</span>, <span class="sc">-</span><span class="fl">0.01192308</span>,</span>
<span id="cb42-944"><a href="the-method.html#cb42-944" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.009</span>, <span class="sc">-</span><span class="fl">0.01041667</span>, <span class="fl">0.6727857</span>, <span class="fl">81.47508</span>, <span class="fl">279.9459</span>, <span class="fl">870.0117</span>, <span class="fl">1304.603</span>, <span class="fl">1713.278</span>,</span>
<span id="cb42-945"><a href="the-method.html#cb42-945" tabindex="-1"></a>  <span class="fl">2235.767</span>, <span class="fl">1578.55</span>, <span class="fl">1455.561</span>, <span class="fl">1173.019</span>, <span class="fl">386.7722</span>, <span class="fl">57.29713</span>, <span class="fl">0.8726</span>, <span class="sc">-</span><span class="fl">0.006333333</span>,</span>
<span id="cb42-946"><a href="the-method.html#cb42-946" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.008833333</span>, <span class="sc">-</span><span class="fl">0.008857143</span>, <span class="sc">-</span><span class="fl">0.009375</span>, <span class="sc">-</span><span class="fl">0.00925</span>, <span class="sc">-</span><span class="fl">0.015</span>, <span class="fl">0.3832</span>, <span class="fl">0.4872308</span>, <span class="fl">30.92275</span>,</span>
<span id="cb42-947"><a href="the-method.html#cb42-947" tabindex="-1"></a>  <span class="fl">213.5052</span>, <span class="fl">462.9413</span>, <span class="fl">692.3243</span>, <span class="fl">1132.996</span>, <span class="fl">2123.787</span>, <span class="fl">2373.636</span>, <span class="fl">2605.431</span>, <span class="fl">2730.907</span>,</span>
<span id="cb42-948"><a href="the-method.html#cb42-948" tabindex="-1"></a>  <span class="fl">2340.096</span>, <span class="fl">1557.706</span>, <span class="fl">860.8426</span>, <span class="fl">743.79</span>, <span class="fl">315.8718</span>, <span class="fl">83.95737</span>, <span class="fl">0.2305</span>, <span class="sc">-</span><span class="fl">0.005583333</span>,</span>
<span id="cb42-949"><a href="the-method.html#cb42-949" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.002230769</span>, <span class="sc">-</span><span class="fl">0.003636364</span>, <span class="sc">-</span><span class="fl">0.006181818</span>, <span class="sc">-</span><span class="fl">0.001235294</span>, <span class="fl">0.1075625</span>, <span class="fl">0.3570769</span>, <span class="fl">0.4778889</span>, <span class="fl">49.719</span>,</span>
<span id="cb42-950"><a href="the-method.html#cb42-950" tabindex="-1"></a>  <span class="fl">354.4997</span>, <span class="fl">817.8346</span>, <span class="fl">1259.956</span>, <span class="fl">2148.988</span>, <span class="fl">2673.856</span>, <span class="fl">2670.551</span>, <span class="fl">2690.914</span>, <span class="fl">2648.071</span>,</span>
<span id="cb42-951"><a href="the-method.html#cb42-951" tabindex="-1"></a>  <span class="fl">2759.417</span>, <span class="fl">2783.573</span>, <span class="fl">2852.975</span>, <span class="fl">2533.883</span>, <span class="fl">1810.079</span>, <span class="fl">422.1133</span>, <span class="fl">0.9876316</span>, <span class="sc">-</span><span class="fl">0.0025</span>,</span>
<span id="cb42-952"><a href="the-method.html#cb42-952" tabindex="-1"></a>  <span class="fl">0.00006666667</span>, <span class="sc">-</span><span class="fl">0.005777778</span>, <span class="sc">-</span><span class="fl">0.004642857</span>, <span class="sc">-</span><span class="fl">0.005333333</span>, <span class="sc">-</span><span class="fl">0.0072</span>, <span class="fl">0.2985</span>, <span class="fl">0.4086667</span>, <span class="fl">75.63286</span>,</span>
<span id="cb42-953"><a href="the-method.html#cb42-953" tabindex="-1"></a>  <span class="fl">353.0761</span>, <span class="fl">724.7677</span>, <span class="fl">1230.961</span>, <span class="fl">1749.818</span>, <span class="fl">2318.679</span>, <span class="fl">2721.202</span>, <span class="fl">3232.953</span>, <span class="fl">3081.986</span>,</span>
<span id="cb42-954"><a href="the-method.html#cb42-954" tabindex="-1"></a>  <span class="fl">2675.911</span>, <span class="fl">2377.742</span>, <span class="fl">1600.023</span>, <span class="fl">999.8954</span>, <span class="fl">0.061</span>, <span class="sc">-</span><span class="fl">0.01078571</span>, <span class="sc">-</span><span class="fl">0.0075</span>, <span class="sc">-</span><span class="fl">0.008666667</span>,</span>
<span id="cb42-955"><a href="the-method.html#cb42-955" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.008777778</span>, <span class="sc">-</span><span class="fl">0.007166667</span>, <span class="sc">-</span><span class="fl">0.008823529</span>, <span class="sc">-</span><span class="fl">0.009875</span>, <span class="fl">0.01844444</span>, <span class="fl">26.37</span>, <span class="fl">179.0059</span>, <span class="fl">551.9136</span>,</span>
<span id="cb42-956"><a href="the-method.html#cb42-956" tabindex="-1"></a>  <span class="fl">1019.848</span>, <span class="fl">1489.251</span>, <span class="fl">1818.534</span>, <span class="fl">2081.818</span>, <span class="fl">2362.124</span>, <span class="fl">2111.173</span>, <span class="fl">1787.832</span>, <span class="fl">1234.41</span>,</span>
<span id="cb42-957"><a href="the-method.html#cb42-957" tabindex="-1"></a>  <span class="fl">603.6168</span>, <span class="fl">219.7619</span>, <span class="fl">40.71359</span>, <span class="fl">0.04358824</span>, <span class="sc">-</span><span class="fl">0.00525</span>, <span class="sc">-</span><span class="fl">0.005</span>, <span class="sc">-</span><span class="fl">0.004</span>, <span class="sc">-</span><span class="fl">0.00575</span>,</span>
<span id="cb42-958"><a href="the-method.html#cb42-958" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.008266667</span>, <span class="sc">-</span><span class="fl">0.003777778</span>, <span class="fl">0.3596875</span>, <span class="fl">0.3949444</span>, <span class="fl">42.80317</span>, <span class="fl">262.8376</span>, <span class="fl">800.8294</span>, <span class="fl">1031.592</span>,</span>
<span id="cb42-959"><a href="the-method.html#cb42-959" tabindex="-1"></a>  <span class="fl">1414.766</span>, <span class="fl">2902.38</span>, <span class="fl">3331.281</span>, <span class="fl">3102.55</span>, <span class="fl">3314.92</span>, <span class="fl">3258.176</span>, <span class="fl">2502.952</span>, <span class="fl">1913.286</span>,</span>
<span id="cb42-960"><a href="the-method.html#cb42-960" tabindex="-1"></a>  <span class="fl">908.4718</span>, <span class="fl">317.1317</span>, <span class="fl">44.07631</span>, <span class="fl">0.01391667</span>, <span class="sc">-</span><span class="fl">0.010875</span>, <span class="sc">-</span><span class="fl">0.008</span>, <span class="sc">-</span><span class="fl">0.005352941</span>, <span class="sc">-</span><span class="fl">0.003705882</span>,</span>
<span id="cb42-961"><a href="the-method.html#cb42-961" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.003263158</span>, <span class="fl">0.01389474</span>, <span class="fl">0.3741875</span>, <span class="fl">0.40085</span>, <span class="fl">97.6352</span>, <span class="fl">526.4492</span>, <span class="fl">1717.746</span>, <span class="fl">2481.61</span>,</span>
<span id="cb42-962"><a href="the-method.html#cb42-962" tabindex="-1"></a>  <span class="fl">2660.157</span>, <span class="fl">3574.407</span>, <span class="fl">3236.346</span>, <span class="fl">3144.131</span>, <span class="fl">3512.318</span>, <span class="fl">3191.223</span>, <span class="fl">3414.783</span>, <span class="fl">2315.886</span>,</span>
<span id="cb42-963"><a href="the-method.html#cb42-963" tabindex="-1"></a>  <span class="fl">1544.328</span>, <span class="fl">845.7028</span>, <span class="fl">48.32487</span>, <span class="fl">0.0098</span>, <span class="sc">-</span><span class="fl">0.004</span>, <span class="sc">-</span><span class="fl">0.0035</span>, <span class="sc">-</span><span class="fl">0.006</span>, <span class="sc">-</span><span class="fl">0.0053125</span>,</span>
<span id="cb42-964"><a href="the-method.html#cb42-964" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.00525</span>, <span class="sc">-</span><span class="fl">0.0007272727</span>, <span class="fl">0.251125</span>, <span class="fl">0.3925625</span>, <span class="fl">31.10895</span>, <span class="fl">349.4825</span>, <span class="fl">989.3238</span>, <span class="fl">1673.217</span>,</span>
<span id="cb42-965"><a href="the-method.html#cb42-965" tabindex="-1"></a>  <span class="fl">3008.452</span>, <span class="fl">3327.474</span>, <span class="fl">3668.375</span>, <span class="fl">3520.383</span>, <span class="fl">3809.708</span>, <span class="fl">3307.647</span>, <span class="fl">3284.979</span>, <span class="fl">3025.367</span>,</span>
<span id="cb42-966"><a href="the-method.html#cb42-966" tabindex="-1"></a>  <span class="fl">2197.985</span>, <span class="fl">1805.234</span>, <span class="fl">36.2584</span>, <span class="sc">-</span><span class="fl">0.0096</span>, <span class="sc">-</span><span class="fl">0.01033333</span>, <span class="sc">-</span><span class="fl">0.006142857</span>, <span class="sc">-</span><span class="fl">0.007416667</span>, <span class="sc">-</span><span class="fl">0.0052</span>,</span>
<span id="cb42-967"><a href="the-method.html#cb42-967" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.007666667</span>, <span class="sc">-</span><span class="fl">0.006375</span>, <span class="sc">-</span><span class="fl">0.009923077</span>, <span class="sc">-</span><span class="fl">0.005222222</span>, <span class="fl">31.77713</span>, <span class="fl">260.5398</span>, <span class="fl">854.8976</span>, <span class="fl">2440.643</span>,</span>
<span id="cb42-968"><a href="the-method.html#cb42-968" tabindex="-1"></a>  <span class="fl">3061.953</span>, <span class="fl">3348.637</span>, <span class="fl">3232.407</span>, <span class="fl">3626.341</span>, <span class="fl">4077.914</span>, <span class="fl">2544.177</span>, <span class="fl">1044.943</span>, <span class="fl">464.6145</span>,</span>
<span id="cb42-969"><a href="the-method.html#cb42-969" tabindex="-1"></a>  <span class="fl">21.11</span>, <span class="sc">-</span><span class="fl">0.01592308</span>, <span class="sc">-</span><span class="fl">0.0135</span>, <span class="sc">-</span><span class="fl">0.01288889</span>, <span class="sc">-</span><span class="fl">0.01535714</span>, <span class="sc">-</span><span class="fl">0.01515789</span>, <span class="sc">-</span><span class="fl">0.01415</span>, <span class="sc">-</span><span class="fl">0.01206667</span>,</span>
<span id="cb42-970"><a href="the-method.html#cb42-970" tabindex="-1"></a>  <span class="sc">-</span><span class="fl">0.01313333</span>, <span class="sc">-</span><span class="fl">0.01109091</span>, <span class="fl">1818.87</span>, <span class="fl">1880.722</span></span>
<span id="cb42-971"><a href="the-method.html#cb42-971" tabindex="-1"></a>  )</span>
<span id="cb42-972"><a href="the-method.html#cb42-972" tabindex="-1"></a>  par <span class="ot">=</span> stats<span class="sc">::</span><span class="fu">ksmooth</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(par), <span class="at">y =</span> par, <span class="at">bandwidth =</span> <span class="dv">5</span>, <span class="at">x.points =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(par))<span class="sc">$</span>y</span>
<span id="cb42-973"><a href="the-method.html#cb42-973" tabindex="-1"></a>  </span>
<span id="cb42-974"><a href="the-method.html#cb42-974" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(seed)) <span class="fu">set.seed</span>(seed)</span>
<span id="cb42-975"><a href="the-method.html#cb42-975" tabindex="-1"></a>  Xrest <span class="ot">=</span> <span class="fu">do.call</span>(cbind, <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(p<span class="dv">-2</span>), <span class="cf">function</span>(ii) stats<span class="sc">::</span><span class="fu">rnorm</span>(TT)) )</span>
<span id="cb42-976"><a href="the-method.html#cb42-976" tabindex="-1"></a>  X <span class="ot">=</span> <span class="fu">cbind</span>(<span class="fu">scale</span>(par[<span class="dv">1</span><span class="sc">:</span>TT]),</span>
<span id="cb42-977"><a href="the-method.html#cb42-977" tabindex="-1"></a>            <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, TT<span class="sc">/</span><span class="dv">2</span>), <span class="fu">rep</span>(<span class="dv">1</span>, TT<span class="sc">/</span><span class="dv">2</span>)),</span>
<span id="cb42-978"><a href="the-method.html#cb42-978" tabindex="-1"></a>            Xrest)<span class="do">## p-2 columns</span></span>
<span id="cb42-979"><a href="the-method.html#cb42-979" tabindex="-1"></a>  <span class="fu">colnames</span>(X) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"par"</span>, <span class="st">"cp"</span>, <span class="fu">paste0</span>(<span class="st">"noise"</span>, <span class="dv">1</span><span class="sc">:</span>(p<span class="dv">-2</span>)))</span>
<span id="cb42-980"><a href="the-method.html#cb42-980" tabindex="-1"></a>  </span>
<span id="cb42-981"><a href="the-method.html#cb42-981" tabindex="-1"></a>  <span class="do">## Beta coefficients</span></span>
<span id="cb42-982"><a href="the-method.html#cb42-982" tabindex="-1"></a>  beta <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> numclust, <span class="at">nrow =</span> p<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb42-983"><a href="the-method.html#cb42-983" tabindex="-1"></a>  beta[<span class="dv">0</span><span class="sc">+</span><span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb42-984"><a href="the-method.html#cb42-984" tabindex="-1"></a>  beta[<span class="dv">1</span><span class="sc">+</span><span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span> beta_par</span>
<span id="cb42-985"><a href="the-method.html#cb42-985" tabindex="-1"></a>  beta[<span class="dv">0</span><span class="sc">+</span><span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">=</span> gap</span>
<span id="cb42-986"><a href="the-method.html#cb42-986" tabindex="-1"></a>  beta[<span class="dv">1</span><span class="sc">+</span><span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">=</span> <span class="sc">-</span>beta_par</span>
<span id="cb42-987"><a href="the-method.html#cb42-987" tabindex="-1"></a>  <span class="fu">colnames</span>(beta) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"clust"</span>, <span class="dv">1</span><span class="sc">:</span>numclust)</span>
<span id="cb42-988"><a href="the-method.html#cb42-988" tabindex="-1"></a>  <span class="fu">rownames</span>(beta) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"intercept"</span>, <span class="st">"par"</span>, <span class="st">"cp"</span>, <span class="fu">paste0</span>(<span class="st">"noise"</span>, <span class="dv">1</span><span class="sc">:</span>(p<span class="dv">-2</span>)))</span>
<span id="cb42-989"><a href="the-method.html#cb42-989" tabindex="-1"></a></span>
<span id="cb42-990"><a href="the-method.html#cb42-990" tabindex="-1"></a>  <span class="do">## alpha coefficients</span></span>
<span id="cb42-991"><a href="the-method.html#cb42-991" tabindex="-1"></a>  alpha <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> numclust, <span class="at">nrow =</span> p<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb42-992"><a href="the-method.html#cb42-992" tabindex="-1"></a>  alpha[<span class="dv">0</span><span class="sc">+</span><span class="dv">1</span>, <span class="dv">2</span>] <span class="ot">=</span> <span class="sc">-</span><span class="dv">10</span></span>
<span id="cb42-993"><a href="the-method.html#cb42-993" tabindex="-1"></a>  alpha[<span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>, <span class="dv">2</span>] <span class="ot">=</span> <span class="dv">10</span> <span class="sc">+</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb42-994"><a href="the-method.html#cb42-994" tabindex="-1"></a></span>
<span id="cb42-995"><a href="the-method.html#cb42-995" tabindex="-1"></a>  <span class="fu">colnames</span>(alpha) <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"clust"</span>, <span class="dv">1</span><span class="sc">:</span>numclust)</span>
<span id="cb42-996"><a href="the-method.html#cb42-996" tabindex="-1"></a>  <span class="fu">rownames</span>(alpha) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"intercept"</span>, <span class="st">"par"</span>, <span class="st">"cp"</span>, <span class="fu">paste0</span>(<span class="st">"noise"</span>, <span class="dv">1</span><span class="sc">:</span>(p<span class="dv">-2</span>)))</span>
<span id="cb42-997"><a href="the-method.html#cb42-997" tabindex="-1"></a></span>
<span id="cb42-998"><a href="the-method.html#cb42-998" tabindex="-1"></a>  mnmat <span class="ot">=</span> <span class="fu">cbind</span>(<span class="dv">1</span>, X) <span class="sc">%*%</span> beta</span>
<span id="cb42-999"><a href="the-method.html#cb42-999" tabindex="-1"></a>  prob <span class="ot">=</span> <span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="dv">1</span>,X) <span class="sc">%*%</span> alpha)</span>
<span id="cb42-1000"><a href="the-method.html#cb42-1000" tabindex="-1"></a>  prob <span class="ot">=</span> prob<span class="sc">/</span><span class="fu">rowSums</span>(prob)</span>
<span id="cb42-1001"><a href="the-method.html#cb42-1001" tabindex="-1"></a>  </span>
<span id="cb42-1002"><a href="the-method.html#cb42-1002" tabindex="-1"></a>  <span class="do">## Samples |nt| memberships out of (1:numclust) according to the probs in prob.</span></span>
<span id="cb42-1003"><a href="the-method.html#cb42-1003" tabindex="-1"></a>  <span class="do">## Data is a probabilistic mixture from these two means, over time.</span></span>
<span id="cb42-1004"><a href="the-method.html#cb42-1004" tabindex="-1"></a>  ylist <span class="ot">=</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>TT,</span>
<span id="cb42-1005"><a href="the-method.html#cb42-1005" tabindex="-1"></a>                 <span class="cf">function</span>(tt){</span>
<span id="cb42-1006"><a href="the-method.html#cb42-1006" tabindex="-1"></a>                   draws <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>numclust,</span>
<span id="cb42-1007"><a href="the-method.html#cb42-1007" tabindex="-1"></a>                                  <span class="at">size =</span> ntlist[tt], <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb42-1008"><a href="the-method.html#cb42-1008" tabindex="-1"></a>                                  <span class="do">## prob = c(prob[[tt]], 1-prob[[tt]]))</span></span>
<span id="cb42-1009"><a href="the-method.html#cb42-1009" tabindex="-1"></a>                                  <span class="at">prob =</span> <span class="fu">c</span>(prob[tt,<span class="dv">1</span>], prob[tt,<span class="dv">2</span>]))</span>
<span id="cb42-1010"><a href="the-method.html#cb42-1010" tabindex="-1"></a>                   mns <span class="ot">=</span> mnmat[tt,]</span>
<span id="cb42-1011"><a href="the-method.html#cb42-1011" tabindex="-1"></a>                   means <span class="ot">=</span> mns[draws]</span>
<span id="cb42-1012"><a href="the-method.html#cb42-1012" tabindex="-1"></a></span>
<span id="cb42-1013"><a href="the-method.html#cb42-1013" tabindex="-1"></a>                   <span class="do">## Add noise to obtain data points.</span></span>
<span id="cb42-1014"><a href="the-method.html#cb42-1014" tabindex="-1"></a>                   omega <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span>pi) <span class="sc">*</span> skew_alpha<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> skew_alpha<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb42-1015"><a href="the-method.html#cb42-1015" tabindex="-1"></a>                   mn_shift <span class="ot">=</span> omega <span class="sc">*</span> skew_alpha <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">+</span>skew_alpha<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">2</span><span class="sc">/</span>pi)</span>
<span id="cb42-1016"><a href="the-method.html#cb42-1016" tabindex="-1"></a>                   noise <span class="ot">=</span> sn<span class="sc">::</span><span class="fu">rsn</span>(ntlist[tt], <span class="at">xi =</span> <span class="dv">0</span>, <span class="at">omega =</span> omega, <span class="at">alpha =</span> skew_alpha) <span class="sc">-</span> mn_shift</span>
<span id="cb42-1017"><a href="the-method.html#cb42-1017" tabindex="-1"></a>                   datapoints <span class="ot">=</span> means <span class="sc">+</span> noise</span>
<span id="cb42-1018"><a href="the-method.html#cb42-1018" tabindex="-1"></a>                   <span class="fu">cbind</span>(datapoints)</span>
<span id="cb42-1019"><a href="the-method.html#cb42-1019" tabindex="-1"></a>                 })</span>
<span id="cb42-1020"><a href="the-method.html#cb42-1020" tabindex="-1"></a>    <span class="do">## stop("Binning doesn't work yet! make_grid and bin_many_cytograms aren't written for 1d data yet.")</span></span>
<span id="cb42-1021"><a href="the-method.html#cb42-1021" tabindex="-1"></a></span>
<span id="cb42-1022"><a href="the-method.html#cb42-1022" tabindex="-1"></a>    <span class="do">## 1. Make grid</span></span>
<span id="cb42-1023"><a href="the-method.html#cb42-1023" tabindex="-1"></a>    dat.grid <span class="ot">=</span> flowmix<span class="sc">::</span><span class="fu">make_grid</span>(ylist, <span class="at">gridsize =</span> dat.gridsize)</span>
<span id="cb42-1024"><a href="the-method.html#cb42-1024" tabindex="-1"></a></span>
<span id="cb42-1025"><a href="the-method.html#cb42-1025" tabindex="-1"></a>    <span class="do">## 2. Bin with just counts</span></span>
<span id="cb42-1026"><a href="the-method.html#cb42-1026" tabindex="-1"></a>    mc.cores <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb42-1027"><a href="the-method.html#cb42-1027" tabindex="-1"></a>    obj <span class="ot">=</span> flowmix<span class="sc">::</span><span class="fu">bin_many_cytograms</span>(ylist, dat.grid, <span class="at">mc.cores =</span> mc.cores, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-1028"><a href="the-method.html#cb42-1028" tabindex="-1"></a>    ybin_list <span class="ot">=</span> obj<span class="sc">$</span>ybin_list</span>
<span id="cb42-1029"><a href="the-method.html#cb42-1029" tabindex="-1"></a>    counts_list <span class="ot">=</span> obj<span class="sc">$</span>counts_list</span>
<span id="cb42-1030"><a href="the-method.html#cb42-1030" tabindex="-1"></a>    sparsecounts_list <span class="ot">=</span> obj<span class="sc">$</span>sparsecounts_list <span class="do">## new</span></span>
<span id="cb42-1031"><a href="the-method.html#cb42-1031" tabindex="-1"></a></span>
<span id="cb42-1032"><a href="the-method.html#cb42-1032" tabindex="-1"></a>    <span class="do">## 4. (NOT USED) Also obtain all the binned midpoints, in a (d^3 x 3) matrix.</span></span>
<span id="cb42-1033"><a href="the-method.html#cb42-1033" tabindex="-1"></a>    <span class="do">## ybin_all = make_ybin(counts = NULL, midpoints = make_midpoints(dat.grid))</span></span>
<span id="cb42-1034"><a href="the-method.html#cb42-1034" tabindex="-1"></a>    ybin_all <span class="ot">=</span> obj<span class="sc">$</span>ybin_all <span class="do">## new</span></span>
<span id="cb42-1035"><a href="the-method.html#cb42-1035" tabindex="-1"></a></span>
<span id="cb42-1036"><a href="the-method.html#cb42-1036" tabindex="-1"></a>    <span class="do">## Assign binned data to static names |ylist| and |countslist|.</span></span>
<span id="cb42-1037"><a href="the-method.html#cb42-1037" tabindex="-1"></a>    ylist <span class="ot">=</span> ybin_list</span>
<span id="cb42-1038"><a href="the-method.html#cb42-1038" tabindex="-1"></a>    countslist <span class="ot">=</span> counts_list</span>
<span id="cb42-1039"><a href="the-method.html#cb42-1039" tabindex="-1"></a>  </span>
<span id="cb42-1040"><a href="the-method.html#cb42-1040" tabindex="-1"></a>  <span class="do">## Other things about the true generating model</span></span>
<span id="cb42-1041"><a href="the-method.html#cb42-1041" tabindex="-1"></a>  sigma <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb42-1042"><a href="the-method.html#cb42-1042" tabindex="-1"></a>  sigma[<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span> sigma[<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb42-1043"><a href="the-method.html#cb42-1043" tabindex="-1"></a>  mn <span class="ot">=</span> <span class="fu">array</span>(<span class="cn">NA</span>,<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb42-1044"><a href="the-method.html#cb42-1044" tabindex="-1"></a>  mn[,<span class="dv">1</span>,] <span class="ot">=</span> mnmat</span>
<span id="cb42-1045"><a href="the-method.html#cb42-1045" tabindex="-1"></a>  numclust<span class="ot">=</span><span class="dv">2</span></span>
<span id="cb42-1046"><a href="the-method.html#cb42-1046" tabindex="-1"></a></span>
<span id="cb42-1047"><a href="the-method.html#cb42-1047" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">ylist =</span> ylist, </span>
<span id="cb42-1048"><a href="the-method.html#cb42-1048" tabindex="-1"></a>              <span class="at">X =</span> X,</span>
<span id="cb42-1049"><a href="the-method.html#cb42-1049" tabindex="-1"></a>              <span class="at">countslist =</span> countslist,</span>
<span id="cb42-1050"><a href="the-method.html#cb42-1050" tabindex="-1"></a>              <span class="do">## The true generating model:</span></span>
<span id="cb42-1051"><a href="the-method.html#cb42-1051" tabindex="-1"></a>              <span class="at">mnmat =</span> mnmat,</span>
<span id="cb42-1052"><a href="the-method.html#cb42-1052" tabindex="-1"></a>              <span class="at">prob =</span> prob,</span>
<span id="cb42-1053"><a href="the-method.html#cb42-1053" tabindex="-1"></a>              <span class="at">mn =</span> mn,</span>
<span id="cb42-1054"><a href="the-method.html#cb42-1054" tabindex="-1"></a>              <span class="at">numclust =</span> numclust,</span>
<span id="cb42-1055"><a href="the-method.html#cb42-1055" tabindex="-1"></a>              <span class="at">alpha =</span> alpha,</span>
<span id="cb42-1056"><a href="the-method.html#cb42-1056" tabindex="-1"></a>              <span class="at">beta =</span> beta,</span>
<span id="cb42-1057"><a href="the-method.html#cb42-1057" tabindex="-1"></a>              <span class="at">sigma =</span> sigma))</span>
<span id="cb42-1058"><a href="the-method.html#cb42-1058" tabindex="-1"></a>}</span></code></pre></div>

</div>
            </section>
</div>
        </div>
      </div>
<a href="the-model.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="conclude.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script><script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script><script src="libs/gitbook-2.6.7/js/plugin-search.js"></script><script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script><script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script><script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script><script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script><script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script><script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
